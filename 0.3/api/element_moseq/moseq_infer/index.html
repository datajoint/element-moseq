
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docs.datajoint.com/elements/element-moseq/0.3/api/element_moseq/moseq_infer/">
      
      
        <link rel="prev" href="../../../citation/">
      
      
        <link rel="next" href="../moseq_train/">
      
      
      <link rel="icon" href="../../../assets/images/company-logo-blue.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>moseq_infer.py - DataJoint Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto Slab";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="datajoint" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#element_moseq.moseq_infer" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="DataJoint Documentation" class="md-header__button md-logo" aria-label="DataJoint Documentation" data-md-component="logo">
      
  
  <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 15.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="260.479px" height="365.463px" viewBox="0 0 260.479 365.463" enable-background="new 0 0 260.479 365.463"
	 xml:space="preserve">
<g>
	<path d="M4.638,361.434c0,0,124.071-124.072,135.896-357.434c0,0,29.555,189.053,115.266,256.988
		C255.799,260.988,173.038,249.174,4.638,361.434z"/>
</g>
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DataJoint Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              moseq_infer.py
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="datajoint" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/datajoint/element-moseq" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    datajoint/element-moseq
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="nav.title" data-md-level="0">
    <label class="md-nav__title" for="__drawer">
        <a href="../../.." title="DataJoint Documentation"
            class="md-nav__button md-logo" aria-label="DataJoint Documentation" data-md-component="logo">
            
  
  <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 15.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="260.479px" height="365.463px" viewBox="0 0 260.479 365.463" enable-background="new 0 0 260.479 365.463"
	 xml:space="preserve">
<g>
	<path d="M4.638,361.434c0,0,124.071-124.072,135.896-357.434c0,0,29.555,189.053,115.266,256.988
		C255.799,260.988,173.038,249.174,4.638,361.434z"/>
</g>
</svg>

        </a><a href="https://docs.datajoint.com/elements/" title="DataJoint Elements">
            â¬… Home
        </a>
    </label>
    
    <div class="md-nav__source">
        <a href="https://github.com/datajoint/element-moseq" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    datajoint/element-moseq
  </div>
</a>
    </div>
    
    <ul class="md-nav__list" data-md-scrollfix>
        
        
        
        



        
        
        
        



        
        
        
        



        
        
        
        



        
        
        
        



        
        
        
        



        
        
        
        



        
        
        
        



        
        
        
        



        
    </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>moseq_infer.py</h1>

<div class="doc doc-object doc-module">



<a id="element_moseq.moseq_infer"></a>
    <div class="doc doc-contents first">

        <p>Code adapted from the Datta Lab
DataJoint Schema for Keypoint-MoSeq inference pipeline</p>









  <div class="doc doc-children">















<div class="doc doc-object doc-function">


<h2 id="element_moseq.moseq_infer.activate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">activate</span><span class="p">(</span><span class="n">infer_schema_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">create_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create_tables</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linking_module</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#element_moseq.moseq_infer.activate" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Activate this schema.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>infer_schema_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Schema name on the database server to activate the <code>moseq_infer</code> schema.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>create_schema</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When True (default), create schema in the database if it
                does not yet exist.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>create_tables</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When True (default), create schema tables in the database
                 if they do not yet exist.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>linking_module</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A module (or name) containing the required dependencies.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="element_moseq.moseq_infer.activate.get_kpms_root_data_dir">get_kpms_root_data_dir</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Returns absolute path for root data director(y/ies) with all behavioral recordings, as (list of) string(s)</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="element_moseq.moseq_infer.activate.get_kpms_processed_data_dir">get_kpms_processed_data_dir</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Optional. Returns absolute path for processed data.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>element_moseq/moseq_infer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">activate</span><span class="p">(</span>
    <span class="n">infer_schema_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">create_schema</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">create_tables</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">linking_module</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Activate this schema.</span>

<span class="sd">    Args:</span>
<span class="sd">        infer_schema_name (str): Schema name on the database server to activate the `moseq_infer` schema.</span>
<span class="sd">        create_schema (bool): When True (default), create schema in the database if it</span>
<span class="sd">                            does not yet exist.</span>
<span class="sd">        create_tables (bool): When True (default), create schema tables in the database</span>
<span class="sd">                             if they do not yet exist.</span>
<span class="sd">        linking_module (str): A module (or name) containing the required dependencies.</span>

<span class="sd">    Functions:</span>
<span class="sd">        get_kpms_root_data_dir(): Returns absolute path for root data director(y/ies) with all behavioral recordings, as (list of) string(s)</span>
<span class="sd">        get_kpms_processed_data_dir(): Optional. Returns absolute path for processed data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linking_module</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">linking_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">linking_module</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismodule</span><span class="p">(</span>
        <span class="n">linking_module</span>
    <span class="p">),</span> <span class="s2">&quot;The argument &#39;dependency&#39; must be a module&#39;s name or a module&quot;</span>
    <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span>
        <span class="n">linking_module</span><span class="p">,</span> <span class="s2">&quot;get_kpms_root_data_dir&quot;</span>
    <span class="p">),</span> <span class="s2">&quot;The linking module must specify a lookup function for a root data directory&quot;</span>

    <span class="k">global</span> <span class="n">_linking_module</span>
    <span class="n">_linking_module</span> <span class="o">=</span> <span class="n">linking_module</span>

    <span class="c1"># activate</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span>
        <span class="n">infer_schema_name</span><span class="p">,</span>
        <span class="n">create_schema</span><span class="o">=</span><span class="n">create_schema</span><span class="p">,</span>
        <span class="n">create_tables</span><span class="o">=</span><span class="n">create_tables</span><span class="p">,</span>
        <span class="n">add_objects</span><span class="o">=</span><span class="n">_linking_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_infer.Model" class="doc doc-heading">
            <code>Model</code>


<a href="#element_moseq.moseq_infer.Model" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Manual">Manual</span></code></p>


        <p>Register a model.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Model.model_id">model_id</span></code></td>
            <td>
                  <code>int)                      </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique ID for each model.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Model.model_name">model_name</span></code></td>
            <td>
                  <code>varchar)                </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>User-friendly model name.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Model.model_dir">model_dir</span></code></td>
            <td>
                  <code>varchar)                 </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model directory relative to root data directory (e.g. <code>kpms_project_output_dir/2024_03_21-00_51_39</code>)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Model.latent_dim">latent_dim</span></code></td>
            <td>
                  <code>int)                    </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Latent dimension of the model.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Model.kappa">kappa</span></code></td>
            <td>
                  <code>float)                       </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Kappa value of the model.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Model.model_desc">model_desc</span></code></td>
            <td>
                  <code>varchar)                </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional. User-defined description of the model</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_infer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register a model.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        model_id (int)                      : Unique ID for each model.</span>
<span class="sd">        model_name (varchar)                : User-friendly model name.</span>
<span class="sd">        model_dir (varchar)                 : Model directory relative to root data directory (e.g. `kpms_project_output_dir/2024_03_21-00_51_39`)</span>
<span class="sd">        latent_dim (int)                    : Latent dimension of the model.</span>
<span class="sd">        kappa (float)                       : Kappa value of the model.</span>
<span class="sd">        model_desc (varchar)                : Optional. User-defined description of the model</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    model_id                : int          # Unique ID for each model</span>
<span class="s2">    ---</span>
<span class="s2">    model_name              : varchar(64)  # User-friendly model name</span>
<span class="s2">    model_dir               : varchar(1000)# Model directory relative to root data directory</span>
<span class="s2">    model_desc=&#39;&#39;           : varchar(1000)# Optional. User-defined description of the model</span>
<span class="s2">    -&gt; [nullable] moseq_train.SelectedFullFit</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_infer.VideoRecording" class="doc doc-heading">
            <code>VideoRecording</code>


<a href="#element_moseq.moseq_infer.VideoRecording" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Manual">Manual</span></code></p>


        <p>Set of video recordings for the Keypoint-MoSeq inference.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.VideoRecording.Session">Session</span></code></td>
            <td>
                  <code>foreign key)               </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>Session</code> key.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.VideoRecording.recording_id">recording_id</span></code></td>
            <td>
                  <code>int)                  </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique ID for each recording.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.VideoRecording.Device">Device</span></code></td>
            <td>
                  <code>foreign key)                </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device primary key.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_infer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">VideoRecording</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set of video recordings for the Keypoint-MoSeq inference.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Session (foreign key)               : `Session` key.</span>
<span class="sd">        recording_id (int)                  : Unique ID for each recording.</span>
<span class="sd">        Device (foreign key)                : Device primary key.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; Session                             # `Session` key</span>
<span class="s2">    recording_id: int                      # Unique ID for each recording</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; Device                              # Device primary key</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">File</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;File IDs and paths associated with a given `recording_id`.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            VideoRecording (foreign key)   : `VideoRecording` key.</span>
<span class="sd">            file_id(int)                   : Unique ID for each file.</span>
<span class="sd">            file_path (varchar)            : Filepath of each video, relative to root data directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; master</span>
<span class="s2">        file_id: int             # Unique ID for each file</span>
<span class="s2">        ---</span>
<span class="s2">        file_path: varchar(1000) # Filepath of each video, relative to root data directory.</span>
<span class="s2">        &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-class">



<h3 id="element_moseq.moseq_infer.VideoRecording.File" class="doc doc-heading">
            <code>File</code>


<a href="#element_moseq.moseq_infer.VideoRecording.File" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Part">Part</span></code></p>


        <p>File IDs and paths associated with a given <code>recording_id</code>.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.VideoRecording.File.VideoRecording">VideoRecording</span></code></td>
            <td>
                  <code>foreign key)   </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>VideoRecording</code> key.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.VideoRecording.File.file_id(int)">file_id(int)</span></code></td>
            <td>
                  <code>                  </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique ID for each file.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.VideoRecording.File.file_path">file_path</span></code></td>
            <td>
                  <code>varchar)            </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Filepath of each video, relative to root data directory.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_infer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">File</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;File IDs and paths associated with a given `recording_id`.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        VideoRecording (foreign key)   : `VideoRecording` key.</span>
<span class="sd">        file_id(int)                   : Unique ID for each file.</span>
<span class="sd">        file_path (varchar)            : Filepath of each video, relative to root data directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; master</span>
<span class="s2">    file_id: int             # Unique ID for each file</span>
<span class="s2">    ---</span>
<span class="s2">    file_path: varchar(1000) # Filepath of each video, relative to root data directory.</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





  </div>

    </div>

</div>




  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_infer.InferenceTask" class="doc doc-heading">
            <code>InferenceTask</code>


<a href="#element_moseq.moseq_infer.InferenceTask" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Manual">Manual</span></code></p>


        <p>Staging table to define the Inference task and its output directory.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.InferenceTask.VideoRecording">VideoRecording</span></code></td>
            <td>
                  <code>foreign key)         </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>VideoRecording</code> key</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.InferenceTask.Model">Model</span></code></td>
            <td>
                  <code>foreign key)                  </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>Model</code> key</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.InferenceTask.PoseEstimationMethod">PoseEstimationMethod</span></code></td>
            <td>
                  <code>foreign key)   </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pose estimation method used for the specified <code>recording_id</code>.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.InferenceTask.inference_output_dir">inference_output_dir</span></code></td>
            <td>
                  <code>varchar)       </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional. Sub-directory where the results will be stored.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.InferenceTask.inference_desc">inference_desc</span></code></td>
            <td>
                  <code>varchar)             </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional. User-defined description of the inference task.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.InferenceTask.num_iterations">num_iterations</span></code></td>
            <td>
                  <code>int)                 </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional. Number of iterations to use for the model inference. If null, the default number internally is 50.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_infer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">InferenceTask</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Staging table to define the Inference task and its output directory.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        VideoRecording (foreign key)         : `VideoRecording` key</span>
<span class="sd">        Model (foreign key)                  : `Model` key</span>
<span class="sd">        PoseEstimationMethod (foreign key)   : Pose estimation method used for the specified `recording_id`.</span>
<span class="sd">        inference_output_dir (varchar)       : Optional. Sub-directory where the results will be stored.</span>
<span class="sd">        inference_desc (varchar)             : Optional. User-defined description of the inference task.</span>
<span class="sd">        num_iterations (int)                 : Optional. Number of iterations to use for the model inference. If null, the default number internally is 50.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; VideoRecording                                       # `VideoRecording` key</span>
<span class="s2">    -&gt; Model                                                # `Model` key</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; moseq_train.PoseEstimationMethod                     # Pose estimation method used for the specified `recording_id`</span>
<span class="s2">    keypointset_dir               : varchar(1000)           # Keypointset directory for the specified VideoRecording</span>
<span class="s2">    inference_output_dir=&#39;&#39;       : varchar(1000)           # Optional. Sub-directory where the results will be stored</span>
<span class="s2">    inference_desc=&#39;&#39;             : varchar(1000)           # Optional. User-defined description of the inference task</span>
<span class="s2">    num_iterations=NULL           : int                     # Optional. Number of iterations to use for the model inference. If null, the default number internally is 50.</span>
<span class="s2">    task_mode=&#39;load&#39;              : enum(&#39;load&#39;, &#39;trigger&#39;) # Task mode for the inference task</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_infer.Inference" class="doc doc-heading">
            <code>Inference</code>


<a href="#element_moseq.moseq_infer.Inference" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Computed">Computed</span></code></p>


        <p>Infer the model from the checkpoint file and save the results as <code>results.h5</code> file.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Inference.InferenceTask">InferenceTask</span></code></td>
            <td>
                  <code>foreign_key)         </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>InferenceTask</code> key.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Inference.inference_duration">inference_duration</span></code></td>
            <td>
                  <code>float)          </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time duration (seconds) of the inference computation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_infer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Inference</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Infer the model from the checkpoint file and save the results as `results.h5` file.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        InferenceTask (foreign_key)         : `InferenceTask` key.</span>
<span class="sd">        inference_duration (float)          : Time duration (seconds) of the inference computation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; InferenceTask                        # `InferenceTask` key</span>
<span class="s2">    ---</span>
<span class="s2">    inference_duration=NULL        : float  # Time duration (seconds) of the inference computation</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">MotionSequence</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store the results of the model inference.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            video_name (varchar)                : Name of the video.</span>
<span class="sd">            syllable (longblob)                 : Syllable labels (z). The syllable label assigned to each frame (i.e. the state indexes assigned by the model).</span>
<span class="sd">            latent_state (longblob)             : Inferred low-dim pose state (x). Low-dimensional representation of the animal&#39;s pose in each frame. These are similar to PCA scores, are modified to reflect the pose dynamics and noise estimates inferred by the model.</span>
<span class="sd">            centroid (longblob)                 : Inferred centroid (v). The centroid of the animal in each frame, as estimated by the model.</span>
<span class="sd">            heading (longblob)                  : Inferred heading (h). The heading of the animal in each frame, as estimated by the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; master</span>
<span class="s2">        video_name      : varchar(150)    # Name of the video</span>
<span class="s2">        ---</span>
<span class="s2">        syllable        : longblob        # Syllable labels (z). The syllable label assigned to each frame (i.e. the state indexes assigned by the model)</span>
<span class="s2">        latent_state    : longblob        # Inferred low-dim pose state (x). Low-dimensional representation of the animal&#39;s pose in each frame. These are similar to PCA scores, are modified to reflect the pose dynamics and noise estimates inferred by the model</span>
<span class="s2">        centroid        : longblob        # Inferred centroid (v). The centroid of the animal in each frame, as estimated by the model</span>
<span class="s2">        heading         : longblob        # Inferred heading (h). The heading of the animal in each frame, as estimated by the model</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">GridMoviesSampledInstances</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store the sampled instances of the grid movies.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            syllable (int)                  : Syllable label.</span>
<span class="sd">            instances (longblob)            : List of instances shown in each in grid movie (in row-major order), where each instance is specified as a tuple with the video name, start frame and end frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; master</span>
<span class="s2">        syllable: int           # Syllable label</span>
<span class="s2">        ---</span>
<span class="s2">        instances: longblob     # List of instances shown in each in grid movie (in row-major order), where each instance is specified as a tuple with the video name, start frame and end frame</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is used to infer the model results from the checkpoint file and store the results in `MotionSequence` and `GridMoviesSampledInstances` tables.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (dict): `InferenceTask` primary key.</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If no pca model (`pca.p`) found in the parent model directory.</span>
<span class="sd">            FileNotFoundError: If no model (`checkpoint.h5`) found in the model directory.</span>
<span class="sd">            NotImplementedError: If the format method is not `deeplabcut`.</span>
<span class="sd">            FileNotFoundError: If no valid `kpms_dj_config` found in the parent model directory.</span>

<span class="sd">        High-level Logic:</span>
<span class="sd">        1. Fetch the `inference_output_dir` where the results will be stored, and if it does not exist, create it.</span>
<span class="sd">        2. Fetch the `model_name` and the `num_iterations` from the `InferenceTask` table.</span>
<span class="sd">        3. Load the most recent model checkpoint and the pca model from files in the `kpms_project_output_dir`.</span>
<span class="sd">        4. Load the keypoint data for inference as `filepath_patterns` and format it.</span>
<span class="sd">        5. Initialize and apply the model with the new keypoint data.</span>
<span class="sd">        6. If the `num_iterations` is set, fit the model with the new keypoint data for `num_iterations` iterations; otherwise, fit the model with the default number of iterations (50).</span>
<span class="sd">        7. Save the results as a CSV file and store the histogram showing the frequency of each syllable.</span>
<span class="sd">        8. Generate and save the plots showing the median trajectory of poses associated with each given syllable.</span>
<span class="sd">        9. Generate and save video clips showing examples of each syllable.</span>
<span class="sd">        10. Generate and save the dendrogram representing distances between each syllable&#39;s median trajectory.</span>
<span class="sd">        11. Insert the inference duration in the `Inference` table.</span>
<span class="sd">        12. Insert the results in the `MotionSequence` and `GridMoviesSampledInstances` tables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">apply_model</span><span class="p">,</span>
            <span class="n">format_data</span><span class="p">,</span>
            <span class="n">generate_grid_movies</span><span class="p">,</span>
            <span class="n">generate_trajectory_plots</span><span class="p">,</span>
            <span class="n">load_checkpoint</span><span class="p">,</span>
            <span class="n">load_keypoints</span><span class="p">,</span>
            <span class="n">load_pca</span><span class="p">,</span>
            <span class="n">plot_similarity_dendrogram</span><span class="p">,</span>
            <span class="n">plot_syllable_frequencies</span><span class="p">,</span>
            <span class="n">save_results_as_csv</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="p">(</span>
            <span class="n">keypointset_dir</span><span class="p">,</span>
            <span class="n">inference_output_dir</span><span class="p">,</span>
            <span class="n">num_iterations</span><span class="p">,</span>
            <span class="n">model_id</span><span class="p">,</span>
            <span class="n">pose_estimation_method</span><span class="p">,</span>
            <span class="n">task_mode</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">InferenceTask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;keypointset_dir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;inference_output_dir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;num_iterations&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pose_estimation_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;task_mode&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">kpms_root</span> <span class="o">=</span> <span class="n">moseq_train</span><span class="o">.</span><span class="n">get_kpms_root_data_dir</span><span class="p">()</span>
        <span class="n">kpms_processed</span> <span class="o">=</span> <span class="n">moseq_train</span><span class="o">.</span><span class="n">get_kpms_processed_data_dir</span><span class="p">()</span>

        <span class="n">model_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span>
            <span class="n">kpms_processed</span><span class="p">,</span>
            <span class="p">(</span><span class="n">Model</span> <span class="o">&amp;</span> <span class="sa">f</span><span class="s2">&quot;model_id = </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;model_dir&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">keypointset_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span><span class="n">kpms_root</span><span class="p">,</span> <span class="n">keypointset_dir</span><span class="p">)</span>

        <span class="n">inference_output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">inference_output_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">inference_output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_dir</span> <span class="o">/</span> <span class="n">inference_output_dir</span><span class="p">)</span>

        <span class="n">pca_path</span> <span class="o">=</span> <span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;pca.p&quot;</span>
        <span class="k">if</span> <span class="n">pca_path</span><span class="p">:</span>
            <span class="n">pca</span> <span class="o">=</span> <span class="n">load_pca</span><span class="p">(</span><span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No pca model (`pca.p`) found in the parent model directory </span><span class="si">{</span><span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">model_path</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;checkpoint.h5&quot;</span>
        <span class="k">if</span> <span class="n">model_path</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span>
                <span class="n">project_dir</span><span class="o">=</span><span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="n">model_dir</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No model (`checkpoint.h5`) found in the model directory </span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">pose_estimation_method</span> <span class="o">==</span> <span class="s2">&quot;deeplabcut&quot;</span><span class="p">:</span>
            <span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_keypoints</span><span class="p">(</span>
                <span class="n">filepath_pattern</span><span class="o">=</span><span class="n">keypointset_dir</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">pose_estimation_method</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;The currently supported format method is `deeplabcut`. If you require </span><span class="se">\</span>
<span class="s2">        support for another format method, please reach out to us at `support@datajoint.com`.&quot;</span>
            <span class="p">)</span>

        <span class="n">kpms_dj_config</span> <span class="o">=</span> <span class="n">load_kpms_dj_config</span><span class="p">(</span>
            <span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="n">check_if_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">build_indexes</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">kpms_dj_config</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">format_data</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span><span class="p">,</span> <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No valid `kpms_dj_config` found in the parent model directory </span><span class="si">{</span><span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">apply_model</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">pca</span><span class="o">=</span><span class="n">pca</span><span class="p">,</span>
                <span class="n">project_dir</span><span class="o">=</span><span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="n">model_name</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">results_path</span><span class="o">=</span><span class="p">(</span><span class="n">inference_output_dir</span> <span class="o">/</span> <span class="s2">&quot;results.h5&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="n">return_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">num_iters</span><span class="o">=</span><span class="n">num_iterations</span>
                <span class="ow">or</span> <span class="mi">50</span><span class="p">,</span>  <span class="c1"># default internal value in the keypoint-moseq function</span>
                <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

            <span class="n">duration_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

            <span class="n">save_results_as_csv</span><span class="p">(</span>
                <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
                <span class="n">save_dir</span><span class="o">=</span><span class="p">(</span><span class="n">inference_output_dir</span> <span class="o">/</span> <span class="s2">&quot;results_as_csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="p">)</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plot_syllable_frequencies</span><span class="p">(</span>
                <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">inference_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">inference_output_dir</span> <span class="o">/</span> <span class="s2">&quot;syllable_frequencies.png&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

            <span class="n">generate_trajectory_plots</span><span class="p">(</span>
                <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
                <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="p">(</span><span class="n">inference_output_dir</span> <span class="o">/</span> <span class="s2">&quot;trajectory_plots&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">sampled_instances</span> <span class="o">=</span> <span class="n">generate_grid_movies</span><span class="p">(</span>
                <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
                <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="p">(</span><span class="n">inference_output_dir</span> <span class="o">/</span> <span class="s2">&quot;grid_movies&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">plot_similarity_dendrogram</span><span class="p">(</span>
                <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
                <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="p">(</span><span class="n">inference_output_dir</span> <span class="o">/</span> <span class="s2">&quot;similarity_dendrogram&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">filter_centroids_headings</span><span class="p">,</span>
                <span class="n">get_syllable_instances</span><span class="p">,</span>
                <span class="n">load_results</span><span class="p">,</span>
                <span class="n">sample_instances</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># load results</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">load_results</span><span class="p">(</span>
                <span class="n">project_dir</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">inference_output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                <span class="n">model_name</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">inference_output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># extract syllables from results</span>
            <span class="n">syllables</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;syllable&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="c1"># extract and smooth centroids and headings</span>
            <span class="n">centroids</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;centroid&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">headings</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;heading&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="n">filter_size</span> <span class="o">=</span> <span class="mi">9</span>  <span class="c1"># default value</span>
            <span class="n">centroids</span><span class="p">,</span> <span class="n">headings</span> <span class="o">=</span> <span class="n">filter_centroids_headings</span><span class="p">(</span>
                <span class="n">centroids</span><span class="p">,</span> <span class="n">headings</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="n">filter_size</span>
            <span class="p">)</span>

            <span class="c1"># extract sample instances for each syllable</span>
            <span class="n">syllable_instances</span> <span class="o">=</span> <span class="n">get_syllable_instances</span><span class="p">(</span>
                <span class="n">syllables</span><span class="p">,</span> <span class="n">min_duration</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_frequency</span><span class="o">=</span><span class="mf">0.005</span>
            <span class="p">)</span>
            <span class="c1"># Map each syllable to a list of its sampled events.</span>
            <span class="n">sampled_instances</span> <span class="o">=</span> <span class="n">sample_instances</span><span class="p">(</span>
                <span class="n">syllable_instances</span><span class="o">=</span><span class="n">syllable_instances</span><span class="p">,</span>
                <span class="n">num_samples</span><span class="o">=</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span>  <span class="c1"># minimum rows * cols</span>
                <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
                <span class="n">centroids</span><span class="o">=</span><span class="n">centroids</span><span class="p">,</span>
                <span class="n">headings</span><span class="o">=</span><span class="n">headings</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">duration_seconds</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">({</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;inference_duration&quot;</span><span class="p">:</span> <span class="n">duration_seconds</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">result_idx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">MotionSequence</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                    <span class="s2">&quot;video_name&quot;</span><span class="p">:</span> <span class="n">result_idx</span><span class="p">,</span>
                    <span class="s2">&quot;syllable&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;syllable&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;latent_state&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;latent_state&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;centroid&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;centroid&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;heading&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;heading&quot;</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">syllable</span><span class="p">,</span> <span class="n">sampled_instance</span> <span class="ow">in</span> <span class="n">sampled_instances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GridMoviesSampledInstances</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
                <span class="p">{</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;syllable&quot;</span><span class="p">:</span> <span class="n">syllable</span><span class="p">,</span> <span class="s2">&quot;instances&quot;</span><span class="p">:</span> <span class="n">sampled_instance</span><span class="p">}</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-class">



<h3 id="element_moseq.moseq_infer.Inference.MotionSequence" class="doc doc-heading">
            <code>MotionSequence</code>


<a href="#element_moseq.moseq_infer.Inference.MotionSequence" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Part">Part</span></code></p>


        <p>Store the results of the model inference.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Inference.MotionSequence.video_name">video_name</span></code></td>
            <td>
                  <code>varchar)                </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the video.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Inference.MotionSequence.syllable">syllable</span></code></td>
            <td>
                  <code>longblob)                 </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Syllable labels (z). The syllable label assigned to each frame (i.e. the state indexes assigned by the model).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Inference.MotionSequence.latent_state">latent_state</span></code></td>
            <td>
                  <code>longblob)             </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inferred low-dim pose state (x). Low-dimensional representation of the animal's pose in each frame. These are similar to PCA scores, are modified to reflect the pose dynamics and noise estimates inferred by the model.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Inference.MotionSequence.centroid">centroid</span></code></td>
            <td>
                  <code>longblob)                 </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inferred centroid (v). The centroid of the animal in each frame, as estimated by the model.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Inference.MotionSequence.heading">heading</span></code></td>
            <td>
                  <code>longblob)                  </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Inferred heading (h). The heading of the animal in each frame, as estimated by the model.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_infer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MotionSequence</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store the results of the model inference.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        video_name (varchar)                : Name of the video.</span>
<span class="sd">        syllable (longblob)                 : Syllable labels (z). The syllable label assigned to each frame (i.e. the state indexes assigned by the model).</span>
<span class="sd">        latent_state (longblob)             : Inferred low-dim pose state (x). Low-dimensional representation of the animal&#39;s pose in each frame. These are similar to PCA scores, are modified to reflect the pose dynamics and noise estimates inferred by the model.</span>
<span class="sd">        centroid (longblob)                 : Inferred centroid (v). The centroid of the animal in each frame, as estimated by the model.</span>
<span class="sd">        heading (longblob)                  : Inferred heading (h). The heading of the animal in each frame, as estimated by the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; master</span>
<span class="s2">    video_name      : varchar(150)    # Name of the video</span>
<span class="s2">    ---</span>
<span class="s2">    syllable        : longblob        # Syllable labels (z). The syllable label assigned to each frame (i.e. the state indexes assigned by the model)</span>
<span class="s2">    latent_state    : longblob        # Inferred low-dim pose state (x). Low-dimensional representation of the animal&#39;s pose in each frame. These are similar to PCA scores, are modified to reflect the pose dynamics and noise estimates inferred by the model</span>
<span class="s2">    centroid        : longblob        # Inferred centroid (v). The centroid of the animal in each frame, as estimated by the model</span>
<span class="s2">    heading         : longblob        # Inferred heading (h). The heading of the animal in each frame, as estimated by the model</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h3 id="element_moseq.moseq_infer.Inference.GridMoviesSampledInstances" class="doc doc-heading">
            <code>GridMoviesSampledInstances</code>


<a href="#element_moseq.moseq_infer.Inference.GridMoviesSampledInstances" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Part">Part</span></code></p>


        <p>Store the sampled instances of the grid movies.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Inference.GridMoviesSampledInstances.syllable">syllable</span></code></td>
            <td>
                  <code>int)                  </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Syllable label.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_infer.Inference.GridMoviesSampledInstances.instances">instances</span></code></td>
            <td>
                  <code>longblob)            </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of instances shown in each in grid movie (in row-major order), where each instance is specified as a tuple with the video name, start frame and end frame.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_infer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GridMoviesSampledInstances</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store the sampled instances of the grid movies.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        syllable (int)                  : Syllable label.</span>
<span class="sd">        instances (longblob)            : List of instances shown in each in grid movie (in row-major order), where each instance is specified as a tuple with the video name, start frame and end frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; master</span>
<span class="s2">    syllable: int           # Syllable label</span>
<span class="s2">    ---</span>
<span class="s2">    instances: longblob     # List of instances shown in each in grid movie (in row-major order), where each instance is specified as a tuple with the video name, start frame and end frame</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





  </div>

    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="element_moseq.moseq_infer.Inference.make" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#element_moseq.moseq_infer.Inference.make" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>This function is used to infer the model results from the checkpoint file and store the results in <code>MotionSequence</code> and <code>GridMoviesSampledInstances</code> tables.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>InferenceTask</code> primary key.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no pca model (<code>pca.p</code>) found in the parent model directory.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no model (<code>checkpoint.h5</code>) found in the model directory.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="NotImplementedError">NotImplementedError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the format method is not <code>deeplabcut</code>.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no valid <code>kpms_dj_config</code> found in the parent model directory.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>High-level Logic:
1. Fetch the <code>inference_output_dir</code> where the results will be stored, and if it does not exist, create it.
2. Fetch the <code>model_name</code> and the <code>num_iterations</code> from the <code>InferenceTask</code> table.
3. Load the most recent model checkpoint and the pca model from files in the <code>kpms_project_output_dir</code>.
4. Load the keypoint data for inference as <code>filepath_patterns</code> and format it.
5. Initialize and apply the model with the new keypoint data.
6. If the <code>num_iterations</code> is set, fit the model with the new keypoint data for <code>num_iterations</code> iterations; otherwise, fit the model with the default number of iterations (50).
7. Save the results as a CSV file and store the histogram showing the frequency of each syllable.
8. Generate and save the plots showing the median trajectory of poses associated with each given syllable.
9. Generate and save video clips showing examples of each syllable.
10. Generate and save the dendrogram representing distances between each syllable's median trajectory.
11. Insert the inference duration in the <code>Inference</code> table.
12. Insert the results in the <code>MotionSequence</code> and <code>GridMoviesSampledInstances</code> tables.</p>


            <details class="quote">
              <summary>Source code in <code>element_moseq/moseq_infer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to infer the model results from the checkpoint file and store the results in `MotionSequence` and `GridMoviesSampledInstances` tables.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (dict): `InferenceTask` primary key.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If no pca model (`pca.p`) found in the parent model directory.</span>
<span class="sd">        FileNotFoundError: If no model (`checkpoint.h5`) found in the model directory.</span>
<span class="sd">        NotImplementedError: If the format method is not `deeplabcut`.</span>
<span class="sd">        FileNotFoundError: If no valid `kpms_dj_config` found in the parent model directory.</span>

<span class="sd">    High-level Logic:</span>
<span class="sd">    1. Fetch the `inference_output_dir` where the results will be stored, and if it does not exist, create it.</span>
<span class="sd">    2. Fetch the `model_name` and the `num_iterations` from the `InferenceTask` table.</span>
<span class="sd">    3. Load the most recent model checkpoint and the pca model from files in the `kpms_project_output_dir`.</span>
<span class="sd">    4. Load the keypoint data for inference as `filepath_patterns` and format it.</span>
<span class="sd">    5. Initialize and apply the model with the new keypoint data.</span>
<span class="sd">    6. If the `num_iterations` is set, fit the model with the new keypoint data for `num_iterations` iterations; otherwise, fit the model with the default number of iterations (50).</span>
<span class="sd">    7. Save the results as a CSV file and store the histogram showing the frequency of each syllable.</span>
<span class="sd">    8. Generate and save the plots showing the median trajectory of poses associated with each given syllable.</span>
<span class="sd">    9. Generate and save video clips showing examples of each syllable.</span>
<span class="sd">    10. Generate and save the dendrogram representing distances between each syllable&#39;s median trajectory.</span>
<span class="sd">    11. Insert the inference duration in the `Inference` table.</span>
<span class="sd">    12. Insert the results in the `MotionSequence` and `GridMoviesSampledInstances` tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">apply_model</span><span class="p">,</span>
        <span class="n">format_data</span><span class="p">,</span>
        <span class="n">generate_grid_movies</span><span class="p">,</span>
        <span class="n">generate_trajectory_plots</span><span class="p">,</span>
        <span class="n">load_checkpoint</span><span class="p">,</span>
        <span class="n">load_keypoints</span><span class="p">,</span>
        <span class="n">load_pca</span><span class="p">,</span>
        <span class="n">plot_similarity_dendrogram</span><span class="p">,</span>
        <span class="n">plot_syllable_frequencies</span><span class="p">,</span>
        <span class="n">save_results_as_csv</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="p">(</span>
        <span class="n">keypointset_dir</span><span class="p">,</span>
        <span class="n">inference_output_dir</span><span class="p">,</span>
        <span class="n">num_iterations</span><span class="p">,</span>
        <span class="n">model_id</span><span class="p">,</span>
        <span class="n">pose_estimation_method</span><span class="p">,</span>
        <span class="n">task_mode</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">InferenceTask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
        <span class="s2">&quot;keypointset_dir&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inference_output_dir&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_iterations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;model_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pose_estimation_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;task_mode&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">kpms_root</span> <span class="o">=</span> <span class="n">moseq_train</span><span class="o">.</span><span class="n">get_kpms_root_data_dir</span><span class="p">()</span>
    <span class="n">kpms_processed</span> <span class="o">=</span> <span class="n">moseq_train</span><span class="o">.</span><span class="n">get_kpms_processed_data_dir</span><span class="p">()</span>

    <span class="n">model_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span>
        <span class="n">kpms_processed</span><span class="p">,</span>
        <span class="p">(</span><span class="n">Model</span> <span class="o">&amp;</span> <span class="sa">f</span><span class="s2">&quot;model_id = </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;model_dir&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">keypointset_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span><span class="n">kpms_root</span><span class="p">,</span> <span class="n">keypointset_dir</span><span class="p">)</span>

    <span class="n">inference_output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">inference_output_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">inference_output_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_dir</span> <span class="o">/</span> <span class="n">inference_output_dir</span><span class="p">)</span>

    <span class="n">pca_path</span> <span class="o">=</span> <span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;pca.p&quot;</span>
    <span class="k">if</span> <span class="n">pca_path</span><span class="p">:</span>
        <span class="n">pca</span> <span class="o">=</span> <span class="n">load_pca</span><span class="p">(</span><span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No pca model (`pca.p`) found in the parent model directory </span><span class="si">{</span><span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">model_path</span> <span class="o">=</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;checkpoint.h5&quot;</span>
    <span class="k">if</span> <span class="n">model_path</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span>
            <span class="n">project_dir</span><span class="o">=</span><span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="n">model_dir</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No model (`checkpoint.h5`) found in the model directory </span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">pose_estimation_method</span> <span class="o">==</span> <span class="s2">&quot;deeplabcut&quot;</span><span class="p">:</span>
        <span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_keypoints</span><span class="p">(</span>
            <span class="n">filepath_pattern</span><span class="o">=</span><span class="n">keypointset_dir</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">pose_estimation_method</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;The currently supported format method is `deeplabcut`. If you require </span><span class="se">\</span>
<span class="s2">    support for another format method, please reach out to us at `support@datajoint.com`.&quot;</span>
        <span class="p">)</span>

    <span class="n">kpms_dj_config</span> <span class="o">=</span> <span class="n">load_kpms_dj_config</span><span class="p">(</span>
        <span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="n">check_if_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">build_indexes</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">kpms_dj_config</span><span class="p">:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">format_data</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span><span class="p">,</span> <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No valid `kpms_dj_config` found in the parent model directory </span><span class="si">{</span><span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">apply_model</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">pca</span><span class="o">=</span><span class="n">pca</span><span class="p">,</span>
            <span class="n">project_dir</span><span class="o">=</span><span class="n">model_dir</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">results_path</span><span class="o">=</span><span class="p">(</span><span class="n">inference_output_dir</span> <span class="o">/</span> <span class="s2">&quot;results.h5&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">return_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_iters</span><span class="o">=</span><span class="n">num_iterations</span>
            <span class="ow">or</span> <span class="mi">50</span><span class="p">,</span>  <span class="c1"># default internal value in the keypoint-moseq function</span>
            <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="n">duration_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="n">save_results_as_csv</span><span class="p">(</span>
            <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="p">(</span><span class="n">inference_output_dir</span> <span class="o">/</span> <span class="s2">&quot;results_as_csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plot_syllable_frequencies</span><span class="p">(</span>
            <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">inference_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">inference_output_dir</span> <span class="o">/</span> <span class="s2">&quot;syllable_frequencies.png&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="n">generate_trajectory_plots</span><span class="p">(</span>
            <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
            <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="p">(</span><span class="n">inference_output_dir</span> <span class="o">/</span> <span class="s2">&quot;trajectory_plots&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">sampled_instances</span> <span class="o">=</span> <span class="n">generate_grid_movies</span><span class="p">(</span>
            <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
            <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="p">(</span><span class="n">inference_output_dir</span> <span class="o">/</span> <span class="s2">&quot;grid_movies&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plot_similarity_dendrogram</span><span class="p">(</span>
            <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
            <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="p">(</span><span class="n">inference_output_dir</span> <span class="o">/</span> <span class="s2">&quot;similarity_dendrogram&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">filter_centroids_headings</span><span class="p">,</span>
            <span class="n">get_syllable_instances</span><span class="p">,</span>
            <span class="n">load_results</span><span class="p">,</span>
            <span class="n">sample_instances</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># load results</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">load_results</span><span class="p">(</span>
            <span class="n">project_dir</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">inference_output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">inference_output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># extract syllables from results</span>
        <span class="n">syllables</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;syllable&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># extract and smooth centroids and headings</span>
        <span class="n">centroids</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;centroid&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">headings</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;heading&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">filter_size</span> <span class="o">=</span> <span class="mi">9</span>  <span class="c1"># default value</span>
        <span class="n">centroids</span><span class="p">,</span> <span class="n">headings</span> <span class="o">=</span> <span class="n">filter_centroids_headings</span><span class="p">(</span>
            <span class="n">centroids</span><span class="p">,</span> <span class="n">headings</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="n">filter_size</span>
        <span class="p">)</span>

        <span class="c1"># extract sample instances for each syllable</span>
        <span class="n">syllable_instances</span> <span class="o">=</span> <span class="n">get_syllable_instances</span><span class="p">(</span>
            <span class="n">syllables</span><span class="p">,</span> <span class="n">min_duration</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_frequency</span><span class="o">=</span><span class="mf">0.005</span>
        <span class="p">)</span>
        <span class="c1"># Map each syllable to a list of its sampled events.</span>
        <span class="n">sampled_instances</span> <span class="o">=</span> <span class="n">sample_instances</span><span class="p">(</span>
            <span class="n">syllable_instances</span><span class="o">=</span><span class="n">syllable_instances</span><span class="p">,</span>
            <span class="n">num_samples</span><span class="o">=</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span>  <span class="c1"># minimum rows * cols</span>
            <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
            <span class="n">centroids</span><span class="o">=</span><span class="n">centroids</span><span class="p">,</span>
            <span class="n">headings</span><span class="o">=</span><span class="n">headings</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">duration_seconds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">({</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;inference_duration&quot;</span><span class="p">:</span> <span class="n">duration_seconds</span><span class="p">})</span>

    <span class="k">for</span> <span class="n">result_idx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MotionSequence</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                <span class="s2">&quot;video_name&quot;</span><span class="p">:</span> <span class="n">result_idx</span><span class="p">,</span>
                <span class="s2">&quot;syllable&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;syllable&quot;</span><span class="p">],</span>
                <span class="s2">&quot;latent_state&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;latent_state&quot;</span><span class="p">],</span>
                <span class="s2">&quot;centroid&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;centroid&quot;</span><span class="p">],</span>
                <span class="s2">&quot;heading&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;heading&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">syllable</span><span class="p">,</span> <span class="n">sampled_instance</span> <span class="ow">in</span> <span class="n">sampled_instances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GridMoviesSampledInstances</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
            <span class="p">{</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;syllable&quot;</span><span class="p">:</span> <span class="n">syllable</span><span class="p">,</span> <span class="s2">&quot;instances&quot;</span><span class="p">:</span> <span class="n">sampled_instance</span><span class="p">}</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://www.datajoint.com" target="_blank" rel="noopener" title="DataJoint" class="md-social__link">
      <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 15.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="260.479px" height="365.463px" viewBox="0 0 260.479 365.463" enable-background="new 0 0 260.479 365.463"
	 xml:space="preserve">
<g>
	<path d="M4.638,361.434c0,0,124.071-124.072,135.896-357.434c0,0,29.555,189.053,115.266,256.988
		C255.799,260.988,173.038,249.174,4.638,361.434z"/>
</g>
</svg>
    </a>
  
    
    
    
    
    <a href="https://datajoint.slack.com" target="_blank" rel="noopener" title="Slack" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1s21.16-47.06 47.06-47.06h47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06S448 171 448 196.9s-21.16 47.06-47.06 47.06h-47.06zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06S309 480 283.1 480s-47.06-21.16-47.06-47.06v-47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06s21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.linkedin.com/company/datajoint" target="_blank" rel="noopener" title="LinkedIn" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://twitter.com/datajoint" target="_blank" rel="noopener" title="Twitter" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
    <a href="https://github.com/datajoint" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="https://hub.docker.com/u/datajoint" target="_blank" rel="noopener" title="DockerHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://pypi.org/user/datajointbot" target="_blank" rel="noopener" title="PyPI" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3"/></svg>
    </a>
  
    
    
    
    
    <a href="https://stackoverflow.com/questions/tagged/datajoint" target="_blank" rel="noopener" title="StackOverflow" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M290.7 311 95 269.7 86.8 309l195.7 41zm51-87L188.2 95.7l-25.5 30.8 153.5 128.3zm-31.2 39.7L129.2 179l-16.7 36.5L293.7 300zM262 32l-32 24 119.3 160.3 32-24zm20.5 328h-200v39.7h200zm39.7 80H42.7V320h-40v160h359.5V320h-40z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.youtube.com/channel/UCdeCuFOTCXlVMRzh6Wk-lGg" target="_blank" rel="noopener" title="YouTube" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305m-317.51 213.508V175.185l142.739 81.205z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["toc.integrate", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="https://js-na1.hs-scripts.com/23133402.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>