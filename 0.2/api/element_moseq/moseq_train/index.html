
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://datajoint.com/docs/elements/element-moseq/0.2/api/element_moseq/moseq_train/">
      
      
        <link rel="prev" href="../moseq_infer/">
      
      
        <link rel="next" href="../readers/kpms_reader/">
      
      
      <link rel="icon" href="../../../assets/images/company-logo-blue.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>moseq_train.py - DataJoint Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto Slab";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="datajoint" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#element_moseq.moseq_train" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="DataJoint Documentation" class="md-header__button md-logo" aria-label="DataJoint Documentation" data-md-component="logo">
      
  
  <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 15.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="260.479px" height="365.463px" viewBox="0 0 260.479 365.463" enable-background="new 0 0 260.479 365.463"
	 xml:space="preserve">
<g>
	<path d="M4.638,361.434c0,0,124.071-124.072,135.896-357.434c0,0,29.555,189.053,115.266,256.988
		C255.799,260.988,173.038,249.174,4.638,361.434z"/>
</g>
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DataJoint Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              moseq_train.py
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="datajoint" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/datajoint/element-moseq" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    datajoint/element-moseq
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="nav.title" data-md-level="0">
    <label class="md-nav__title" for="__drawer">
        <a href="../../.." title="DataJoint Documentation"
            class="md-nav__button md-logo" aria-label="DataJoint Documentation" data-md-component="logo">
            
  
  <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 15.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="260.479px" height="365.463px" viewBox="0 0 260.479 365.463" enable-background="new 0 0 260.479 365.463"
	 xml:space="preserve">
<g>
	<path d="M4.638,361.434c0,0,124.071-124.072,135.896-357.434c0,0,29.555,189.053,115.266,256.988
		C255.799,260.988,173.038,249.174,4.638,361.434z"/>
</g>
</svg>

        </a><a href="https://datajoint.com/docs/elements/" title="DataJoint Elements">
            ⬅ Home
        </a>
    </label>
    
    <div class="md-nav__source">
        <a href="https://github.com/datajoint/element-moseq" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    datajoint/element-moseq
  </div>
</a>
    </div>
    
    <ul class="md-nav__list" data-md-scrollfix>
        
        
        
        



        
        
        
        



        
        
        
        



        
        
        
        



        
        
        
        



        
        
        
        



        
        
        
        



        
        
        
        



        
        
        
        



        
    </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>moseq_train.py</h1>

<div class="doc doc-object doc-module">



<a id="element_moseq.moseq_train"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">















<div class="doc doc-object doc-function">


<h2 id="element_moseq.moseq_train.activate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">activate</span><span class="p">(</span><span class="n">train_schema_name</span><span class="p">,</span> <span class="n">infer_schema_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">create_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create_tables</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linking_module</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#element_moseq.moseq_train.activate" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Activate this schema.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>train_schema_name</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string containing the name of the <code>moseq_train</code> schema.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>infer_schema_name</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string containing the name of the <code>moseq_infer</code> schema.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>create_schema</code>
            </td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True (default), schema  will be created in the database.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>create_tables</code>
            </td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True (default), tables related to the schema will be created in the database.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>linking_module</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string containing the module name or module containing the required dependencies to activate the schema.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Dependencies:
Functions:
    get_kpms_root_data_dir(): Returns absolute path for root data director(y/ies)
                             with all behavioral recordings, as (list of) string(s).
    get_kpms_processed_data_dir(): Optional. Returns absolute path for processed
                                  data.</p>

            <details class="quote">
              <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">activate</span><span class="p">(</span>
    <span class="n">train_schema_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">infer_schema_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">create_schema</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">create_tables</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">linking_module</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Activate this schema.</span>

<span class="sd">    Args:</span>
<span class="sd">        train_schema_name (str): A string containing the name of the `moseq_train` schema.</span>
<span class="sd">        infer_schema_name (str): A string containing the name of the `moseq_infer` schema.</span>
<span class="sd">        create_schema (bool): If True (default), schema  will be created in the database.</span>
<span class="sd">        create_tables (bool): If True (default), tables related to the schema will be created in the database.</span>
<span class="sd">        linking_module (str): A string containing the module name or module containing the required dependencies to activate the schema.</span>
<span class="sd">    Dependencies:</span>
<span class="sd">    Functions:</span>
<span class="sd">        get_kpms_root_data_dir(): Returns absolute path for root data director(y/ies)</span>
<span class="sd">                                 with all behavioral recordings, as (list of) string(s).</span>
<span class="sd">        get_kpms_processed_data_dir(): Optional. Returns absolute path for processed</span>
<span class="sd">                                      data.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linking_module</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">linking_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">linking_module</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismodule</span><span class="p">(</span>
        <span class="n">linking_module</span>
    <span class="p">),</span> <span class="s2">&quot;The argument &#39;dependency&#39; must be a module&#39;s name or a module&quot;</span>

    <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span>
        <span class="n">linking_module</span><span class="p">,</span> <span class="s2">&quot;get_kpms_root_data_dir&quot;</span>
    <span class="p">),</span> <span class="s2">&quot;The linking module must specify a lookup function for a root data directory&quot;</span>

    <span class="k">global</span> <span class="n">_linking_module</span>
    <span class="n">_linking_module</span> <span class="o">=</span> <span class="n">linking_module</span>

    <span class="c1"># activate</span>
    <span class="n">moseq_infer</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span>
        <span class="n">infer_schema_name</span><span class="p">,</span>
        <span class="n">create_schema</span><span class="o">=</span><span class="n">create_schema</span><span class="p">,</span>
        <span class="n">create_tables</span><span class="o">=</span><span class="n">create_tables</span><span class="p">,</span>
        <span class="n">linking_module</span><span class="o">=</span><span class="n">linking_module</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">schema</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span>
        <span class="n">train_schema_name</span><span class="p">,</span>
        <span class="n">create_schema</span><span class="o">=</span><span class="n">create_schema</span><span class="p">,</span>
        <span class="n">create_tables</span><span class="o">=</span><span class="n">create_tables</span><span class="p">,</span>
        <span class="n">add_objects</span><span class="o">=</span><span class="n">_linking_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_train.KeypointSet" class="doc doc-heading">
            <code>KeypointSet</code>


<a href="#element_moseq.moseq_train.KeypointSet" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Manual">Manual</span></code></p>


        <p>Store the keypoint data and the video set directory for model training.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.KeypointSet.kpset_id">kpset_id</span></code></td>
            <td>
                  <code>int)                          </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique ID for each keypoint set.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.KeypointSet.PoseEstimationMethod">PoseEstimationMethod</span></code></td>
            <td>
                  <code>foreign key)      </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique format method used to obtain the keypoints data.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.KeypointSet.kpset_dir">kpset_dir</span></code></td>
            <td>
                  <code>str)                         </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the keypoint files are located together with the pose estimation <code>config</code> file, relative to root data directory.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.KeypointSet.kpset_desc">kpset_desc</span></code></td>
            <td>
                  <code>str)                            </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional. User-entered description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">KeypointSet</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store the keypoint data and the video set directory for model training.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        kpset_id (int)                          : Unique ID for each keypoint set.</span>
<span class="sd">        PoseEstimationMethod (foreign key)      : Unique format method used to obtain the keypoints data.</span>
<span class="sd">        kpset_dir (str)                         : Path where the keypoint files are located together with the pose estimation `config` file, relative to root data directory.</span>
<span class="sd">        kpset_desc (str)                            : Optional. User-entered description.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    kpset_id                        : int           # Unique ID for each keypoint set   </span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; moseq_infer.PoseEstimationMethod             # Unique format method used to obtain the keypoints data</span>
<span class="s2">    kpset_dir                       : varchar(255)  # Path where the keypoint files are located together with the pose estimation `config` file, relative to root data directory </span>
<span class="s2">    kpset_desc=&#39;&#39;                   : varchar(1000) # Optional. User-entered description</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">VideoFile</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store the IDs and file paths of each video file that will be used for model training.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            KeypointSet (foreign key) : Unique ID for each keypoint set.</span>
<span class="sd">            video_id (int)            : Unique ID for each video corresponding to each keypoint data file, relative to root data directory.</span>
<span class="sd">            video_path (str)          : Filepath of each video from which the keypoints are derived, relative to root data directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; master</span>
<span class="s2">        video_id                    : int           # Unique ID for each video corresponding to each keypoint data file, relative to root data directory</span>
<span class="s2">        ---</span>
<span class="s2">        video_path                  : varchar(1000) # Filepath of each video from which the keypoints are derived, relative to root data directory</span>
<span class="s2">        &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-class">



<h3 id="element_moseq.moseq_train.KeypointSet.VideoFile" class="doc doc-heading">
            <code>VideoFile</code>


<a href="#element_moseq.moseq_train.KeypointSet.VideoFile" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Part">Part</span></code></p>


        <p>Store the IDs and file paths of each video file that will be used for model training.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.KeypointSet.VideoFile.KeypointSet">KeypointSet</span></code></td>
            <td>
                  <code>foreign key) </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique ID for each keypoint set.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.KeypointSet.VideoFile.video_id">video_id</span></code></td>
            <td>
                  <code>int)            </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique ID for each video corresponding to each keypoint data file, relative to root data directory.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.KeypointSet.VideoFile.video_path">video_path</span></code></td>
            <td>
                  <code>str)          </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Filepath of each video from which the keypoints are derived, relative to root data directory.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">VideoFile</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store the IDs and file paths of each video file that will be used for model training.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        KeypointSet (foreign key) : Unique ID for each keypoint set.</span>
<span class="sd">        video_id (int)            : Unique ID for each video corresponding to each keypoint data file, relative to root data directory.</span>
<span class="sd">        video_path (str)          : Filepath of each video from which the keypoints are derived, relative to root data directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; master</span>
<span class="s2">    video_id                    : int           # Unique ID for each video corresponding to each keypoint data file, relative to root data directory</span>
<span class="s2">    ---</span>
<span class="s2">    video_path                  : varchar(1000) # Filepath of each video from which the keypoints are derived, relative to root data directory</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





  </div>

    </div>

</div>




  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_train.Bodyparts" class="doc doc-heading">
            <code>Bodyparts</code>


<a href="#element_moseq.moseq_train.Bodyparts" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Manual">Manual</span></code></p>


        <p>Store the body parts to use in the analysis.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.Bodyparts.KeypointSet">KeypointSet</span></code></td>
            <td>
                  <code>foreign key)       </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique ID for each <code>KeypointSet</code> key.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.Bodyparts.bodyparts_id">bodyparts_id</span></code></td>
            <td>
                  <code>int)              </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique ID for a set of bodyparts for a particular keypoint set.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.Bodyparts.anterior_bodyparts">anterior_bodyparts</span></code></td>
            <td>
                  <code>blob)       </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of strings of anterior bodyparts</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.Bodyparts.posterior_bodyparts">posterior_bodyparts</span></code></td>
            <td>
                  <code>blob)      </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of strings of posterior bodyparts</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.Bodyparts.use_bodyparts">use_bodyparts</span></code></td>
            <td>
                  <code>blob)            </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of strings of bodyparts to be used</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.Bodyparts.bodyparts_desc(varchar)">bodyparts_desc(varchar)</span></code></td>
            <td>
                  <code>        </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional. User-entered description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Bodyparts</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store the body parts to use in the analysis.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        KeypointSet (foreign key)       : Unique ID for each `KeypointSet` key.</span>
<span class="sd">        bodyparts_id (int)              : Unique ID for a set of bodyparts for a particular keypoint set.</span>
<span class="sd">        anterior_bodyparts (blob)       : List of strings of anterior bodyparts</span>
<span class="sd">        posterior_bodyparts (blob)      : List of strings of posterior bodyparts</span>
<span class="sd">        use_bodyparts (blob)            : List of strings of bodyparts to be used</span>
<span class="sd">        bodyparts_desc(varchar)         : Optional. User-entered description.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; KeypointSet                              # Unique ID for each `KeypointSet` key</span>
<span class="s2">    bodyparts_id                : int           # Unique ID for a set of bodyparts for a particular keypoint set</span>
<span class="s2">    ---</span>
<span class="s2">    anterior_bodyparts          : blob          # List of strings of anterior bodyparts</span>
<span class="s2">    posterior_bodyparts         : blob          # List of strings of posterior bodyparts</span>
<span class="s2">    use_bodyparts               : blob          # List of strings of bodyparts to be used</span>
<span class="s2">    bodyparts_desc=&#39;&#39;           : varchar(1000) # Optional. User-entered description</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_train.PCATask" class="doc doc-heading">
            <code>PCATask</code>


<a href="#element_moseq.moseq_train.PCATask" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Manual">Manual</span></code></p>


        <p>Staging table to define the PCA task and its output directory.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PCATask.Bodyparts">Bodyparts</span></code></td>
            <td>
                  <code>foreign key)         </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique ID for each <code>Bodyparts</code> key</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PCATask.kpms_project_output_dir">kpms_project_output_dir</span></code></td>
            <td>
                  <code>str)   </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keypoint-MoSeq project output directory, relative to root data directory</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PCATask</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Staging table to define the PCA task and its output directory.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Bodyparts (foreign key)         : Unique ID for each `Bodyparts` key</span>
<span class="sd">        kpms_project_output_dir (str)   : Keypoint-MoSeq project output directory, relative to root data directory</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; </span>
<span class="s2">    -&gt; Bodyparts                                                # Unique ID for each `Bodyparts` key</span>
<span class="s2">    ---</span>
<span class="s2">    kpms_project_output_dir=&#39;&#39;          : varchar(255)          # Keypoint-MoSeq project output directory, relative to root data directory</span>
<span class="s2">    task_mode=&#39;load&#39;                 :enum(&#39;load&#39;,&#39;trigger&#39;) # Trigger or load the task</span>

<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_train.PCAPrep" class="doc doc-heading">
            <code>PCAPrep</code>


<a href="#element_moseq.moseq_train.PCAPrep" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Imported">Imported</span></code></p>


        <p>Table to set up the Keypoint-MoSeq project output directory (<code>kpms_project_output_dir</code>) , creating the default <code>config.yml</code> and updating it in a new <code>kpms_dj_config.yml</code>.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PCAPrep.PCATask">PCATask</span></code></td>
            <td>
                  <code>foreign key)           </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique ID for each <code>PCATask</code> key.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PCAPrep.coordinates">coordinates</span></code></td>
            <td>
                  <code>longblob)          </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping filenames to keypoint coordinates as ndarrays of shape (n_frames, n_bodyparts, 2[or 3]).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PCAPrep.confidences">confidences</span></code></td>
            <td>
                  <code>longblob)          </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping filenames to <code>likelihood</code> scores as ndarrays of shape (n_frames, n_bodyparts).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PCAPrep.formatted_bodyparts">formatted_bodyparts</span></code></td>
            <td>
                  <code>longblob)  </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of bodypart names. The order of the names matches the order of the bodyparts in <code>coordinates</code> and <code>confidences</code>.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PCAPrep.average_frame_rate">average_frame_rate</span></code></td>
            <td>
                  <code>float)      </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Average frame rate of the videos for model training.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PCAPrep.frame_rates">frame_rates</span></code></td>
            <td>
                  <code>longblob)          </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of the frame rates of the videos for model training.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PCAPrep</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Imported</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Table to set up the Keypoint-MoSeq project output directory (`kpms_project_output_dir`) , creating the default `config.yml` and updating it in a new `kpms_dj_config.yml`.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        PCATask (foreign key)           : Unique ID for each `PCATask` key.</span>
<span class="sd">        coordinates (longblob)          : Dictionary mapping filenames to keypoint coordinates as ndarrays of shape (n_frames, n_bodyparts, 2[or 3]).</span>
<span class="sd">        confidences (longblob)          : Dictionary mapping filenames to `likelihood` scores as ndarrays of shape (n_frames, n_bodyparts).</span>
<span class="sd">        formatted_bodyparts (longblob)  : List of bodypart names. The order of the names matches the order of the bodyparts in `coordinates` and `confidences`.</span>
<span class="sd">        average_frame_rate (float)      : Average frame rate of the videos for model training.</span>
<span class="sd">        frame_rates (longblob)          : List of the frame rates of the videos for model training.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; PCATask                          # Unique ID for each `PCATask` key</span>
<span class="s2">    ---</span>
<span class="s2">    coordinates             : longblob  # Dictionary mapping filenames to keypoint coordinates as ndarrays of shape (n_frames, n_bodyparts, 2[or 3])</span>
<span class="s2">    confidences             : longblob  # Dictionary mapping filenames to `likelihood` scores as ndarrays of shape (n_frames, n_bodyparts)           </span>
<span class="s2">    formatted_bodyparts     : longblob  # List of bodypart names. The order of the names matches the order of the bodyparts in `coordinates` and `confidences`.</span>
<span class="s2">    average_frame_rate      : float     # Average frame rate of the videos for model training</span>
<span class="s2">    frame_rates             : longblob  # List of the frame rates of the videos for model training</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make function to:</span>
<span class="sd">        1. Generate and update the `kpms_dj_config.yml` with both the videoset directory and the bodyparts.</span>
<span class="sd">        2. Create the keypoint coordinates and confidences scores to format the data for the PCA fitting.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (dict): Primary key from the `PCATask` table.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: `pose_estimation_method` is only supported for `deeplabcut`.</span>

<span class="sd">        High-Level Logic:</span>
<span class="sd">        1. Fetches the bodyparts, format method, and the directories for the Keypoint-MoSeq project output, the keypoint set, and the video set.</span>
<span class="sd">        2. Set variables for each of the full path of the mentioned directories.</span>
<span class="sd">        3. Find the first existing pose estimation config file in the `kpset_dir` directory, if not found, raise an error.</span>
<span class="sd">        4. Check that the pose_estimation_method is `deeplabcut` and set up the project output directory with the default `config.yml`.</span>
<span class="sd">        5. Create the `kpms_project_output_dir` (if it does not exist), and generates the kpms default `config.yml` with the default values from the pose estimation config.</span>
<span class="sd">        6. Create a copy of the kpms `config.yml` named `kpms_dj_config.yml` that will be updated with both the `video_dir` and bodyparts</span>
<span class="sd">        7. Load keypoint data from the keypoint files found in the `kpset_dir` that will serve as the training set.</span>
<span class="sd">        8. As a result of the keypoint loading, the coordinates and confidences scores are generated and will be used to format the data for modeling.</span>
<span class="sd">        9. Calculate the average frame rate and the frame rate list of the videoset from which the keypoint set is derived. This two attributes can be used to calculate the kappa value.</span>
<span class="sd">        10. Insert the results of this `make` function into the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_project</span><span class="p">,</span> <span class="n">load_config</span><span class="p">,</span> <span class="n">load_keypoints</span>

        <span class="n">anterior_bodyparts</span><span class="p">,</span> <span class="n">posterior_bodyparts</span><span class="p">,</span> <span class="n">use_bodyparts</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Bodyparts</span> <span class="o">&amp;</span> <span class="n">key</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;anterior_bodyparts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;posterior_bodyparts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;use_bodyparts&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">pose_estimation_method</span><span class="p">,</span> <span class="n">kpset_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">KeypointSet</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;pose_estimation_method&quot;</span><span class="p">,</span> <span class="s2">&quot;kpset_dir&quot;</span>
        <span class="p">)</span>
        <span class="n">video_paths</span><span class="p">,</span> <span class="n">video_ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">KeypointSet</span><span class="o">.</span><span class="n">VideoFile</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
            <span class="s2">&quot;video_path&quot;</span><span class="p">,</span> <span class="s2">&quot;video_id&quot;</span>
        <span class="p">)</span>

        <span class="n">kpms_root</span> <span class="o">=</span> <span class="n">moseq_infer</span><span class="o">.</span><span class="n">get_kpms_root_data_dir</span><span class="p">()</span>
        <span class="n">kpms_processed</span> <span class="o">=</span> <span class="n">moseq_infer</span><span class="o">.</span><span class="n">get_kpms_processed_data_dir</span><span class="p">()</span>

        <span class="n">kpms_project_output_dir</span><span class="p">,</span> <span class="n">task_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCATask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;kpms_project_output_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;task_mode&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span>
                    <span class="n">kpms_processed</span><span class="p">,</span> <span class="n">kpms_project_output_dir</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="n">kpms_processed</span> <span class="o">/</span> <span class="n">kpms_project_output_dir</span>

            <span class="n">kpset_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span><span class="n">kpms_root</span><span class="p">,</span> <span class="n">kpset_dir</span><span class="p">)</span>
            <span class="n">videos_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span><span class="n">kpms_root</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">video_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pose_estimation_method</span> <span class="o">==</span> <span class="s2">&quot;deeplabcut&quot;</span><span class="p">:</span>
                <span class="n">setup_project</span><span class="p">(</span>
                    <span class="n">project_dir</span><span class="o">=</span><span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                    <span class="n">deeplabcut_config</span><span class="o">=</span><span class="p">(</span><span class="n">kpset_dir</span> <span class="o">/</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="p">(</span><span class="n">kpset_dir</span> <span class="o">/</span> <span class="s2">&quot;config.yml&quot;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;Currently, `deeplabcut` is the only pose estimation method supported by this Element. Please reach out at `support@datajoint.com` if you use another method.&quot;</span>
                <span class="p">)</span>

            <span class="n">kpms_config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span>
                <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="n">check_if_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">build_indexes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">kpms_dj_config_kwargs_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">video_dir</span><span class="o">=</span><span class="n">videos_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="n">anterior_bodyparts</span><span class="o">=</span><span class="n">anterior_bodyparts</span><span class="p">,</span>
                <span class="n">posterior_bodyparts</span><span class="o">=</span><span class="n">posterior_bodyparts</span><span class="p">,</span>
                <span class="n">use_bodyparts</span><span class="o">=</span><span class="n">use_bodyparts</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">kpms_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kpms_dj_config_kwargs_dict</span><span class="p">)</span>
            <span class="n">kpms_reader</span><span class="o">.</span><span class="n">generate_kpms_dj_config</span><span class="p">(</span>
                <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="o">**</span><span class="n">kpms_config</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span>
                <span class="n">kpms_processed</span><span class="p">,</span> <span class="n">kpms_project_output_dir</span>
            <span class="p">)</span>
            <span class="n">kpset_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span><span class="n">kpms_root</span><span class="p">,</span> <span class="n">kpset_dir</span><span class="p">)</span>
            <span class="n">videos_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span><span class="n">kpms_root</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">video_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

        <span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span><span class="p">,</span> <span class="n">formatted_bodyparts</span> <span class="o">=</span> <span class="n">load_keypoints</span><span class="p">(</span>
            <span class="n">filepath_pattern</span><span class="o">=</span><span class="n">kpset_dir</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">pose_estimation_method</span>
        <span class="p">)</span>

        <span class="n">frame_rate_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fp</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">video_paths</span><span class="p">,</span> <span class="n">video_ids</span><span class="p">):</span>
            <span class="n">video_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">find_full_path</span><span class="p">(</span><span class="n">kpms_root</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
            <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
            <span class="n">frame_rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)))</span>
            <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">average_frame_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">frame_rate_list</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
                <span class="n">confidences</span><span class="o">=</span><span class="n">confidences</span><span class="p">,</span>
                <span class="n">formatted_bodyparts</span><span class="o">=</span><span class="n">formatted_bodyparts</span><span class="p">,</span>
                <span class="n">average_frame_rate</span><span class="o">=</span><span class="n">average_frame_rate</span><span class="p">,</span>
                <span class="n">frame_rates</span><span class="o">=</span><span class="n">frame_rate_list</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-function">


<h3 id="element_moseq.moseq_train.PCAPrep.make" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#element_moseq.moseq_train.PCAPrep.make" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Make function to:
1. Generate and update the <code>kpms_dj_config.yml</code> with both the videoset directory and the bodyparts.
2. Create the keypoint coordinates and confidences scores to format the data for the PCA fitting.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Primary key from the <code>PCATask</code> table.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>NotImplementedError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>pose_estimation_method</code> is only supported for <code>deeplabcut</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>High-Level Logic:
1. Fetches the bodyparts, format method, and the directories for the Keypoint-MoSeq project output, the keypoint set, and the video set.
2. Set variables for each of the full path of the mentioned directories.
3. Find the first existing pose estimation config file in the <code>kpset_dir</code> directory, if not found, raise an error.
4. Check that the pose_estimation_method is <code>deeplabcut</code> and set up the project output directory with the default <code>config.yml</code>.
5. Create the <code>kpms_project_output_dir</code> (if it does not exist), and generates the kpms default <code>config.yml</code> with the default values from the pose estimation config.
6. Create a copy of the kpms <code>config.yml</code> named <code>kpms_dj_config.yml</code> that will be updated with both the <code>video_dir</code> and bodyparts
7. Load keypoint data from the keypoint files found in the <code>kpset_dir</code> that will serve as the training set.
8. As a result of the keypoint loading, the coordinates and confidences scores are generated and will be used to format the data for modeling.
9. Calculate the average frame rate and the frame rate list of the videoset from which the keypoint set is derived. This two attributes can be used to calculate the kappa value.
10. Insert the results of this <code>make</code> function into the table.</p>

            <details class="quote">
              <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make function to:</span>
<span class="sd">    1. Generate and update the `kpms_dj_config.yml` with both the videoset directory and the bodyparts.</span>
<span class="sd">    2. Create the keypoint coordinates and confidences scores to format the data for the PCA fitting.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (dict): Primary key from the `PCATask` table.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: `pose_estimation_method` is only supported for `deeplabcut`.</span>

<span class="sd">    High-Level Logic:</span>
<span class="sd">    1. Fetches the bodyparts, format method, and the directories for the Keypoint-MoSeq project output, the keypoint set, and the video set.</span>
<span class="sd">    2. Set variables for each of the full path of the mentioned directories.</span>
<span class="sd">    3. Find the first existing pose estimation config file in the `kpset_dir` directory, if not found, raise an error.</span>
<span class="sd">    4. Check that the pose_estimation_method is `deeplabcut` and set up the project output directory with the default `config.yml`.</span>
<span class="sd">    5. Create the `kpms_project_output_dir` (if it does not exist), and generates the kpms default `config.yml` with the default values from the pose estimation config.</span>
<span class="sd">    6. Create a copy of the kpms `config.yml` named `kpms_dj_config.yml` that will be updated with both the `video_dir` and bodyparts</span>
<span class="sd">    7. Load keypoint data from the keypoint files found in the `kpset_dir` that will serve as the training set.</span>
<span class="sd">    8. As a result of the keypoint loading, the coordinates and confidences scores are generated and will be used to format the data for modeling.</span>
<span class="sd">    9. Calculate the average frame rate and the frame rate list of the videoset from which the keypoint set is derived. This two attributes can be used to calculate the kappa value.</span>
<span class="sd">    10. Insert the results of this `make` function into the table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_project</span><span class="p">,</span> <span class="n">load_config</span><span class="p">,</span> <span class="n">load_keypoints</span>

    <span class="n">anterior_bodyparts</span><span class="p">,</span> <span class="n">posterior_bodyparts</span><span class="p">,</span> <span class="n">use_bodyparts</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Bodyparts</span> <span class="o">&amp;</span> <span class="n">key</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
        <span class="s2">&quot;anterior_bodyparts&quot;</span><span class="p">,</span>
        <span class="s2">&quot;posterior_bodyparts&quot;</span><span class="p">,</span>
        <span class="s2">&quot;use_bodyparts&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">pose_estimation_method</span><span class="p">,</span> <span class="n">kpset_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">KeypointSet</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
        <span class="s2">&quot;pose_estimation_method&quot;</span><span class="p">,</span> <span class="s2">&quot;kpset_dir&quot;</span>
    <span class="p">)</span>
    <span class="n">video_paths</span><span class="p">,</span> <span class="n">video_ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">KeypointSet</span><span class="o">.</span><span class="n">VideoFile</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
        <span class="s2">&quot;video_path&quot;</span><span class="p">,</span> <span class="s2">&quot;video_id&quot;</span>
    <span class="p">)</span>

    <span class="n">kpms_root</span> <span class="o">=</span> <span class="n">moseq_infer</span><span class="o">.</span><span class="n">get_kpms_root_data_dir</span><span class="p">()</span>
    <span class="n">kpms_processed</span> <span class="o">=</span> <span class="n">moseq_infer</span><span class="o">.</span><span class="n">get_kpms_processed_data_dir</span><span class="p">()</span>

    <span class="n">kpms_project_output_dir</span><span class="p">,</span> <span class="n">task_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCATask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
        <span class="s2">&quot;kpms_project_output_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;task_mode&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span>
                <span class="n">kpms_processed</span><span class="p">,</span> <span class="n">kpms_project_output_dir</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="n">kpms_processed</span> <span class="o">/</span> <span class="n">kpms_project_output_dir</span>

        <span class="n">kpset_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span><span class="n">kpms_root</span><span class="p">,</span> <span class="n">kpset_dir</span><span class="p">)</span>
        <span class="n">videos_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span><span class="n">kpms_root</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">video_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pose_estimation_method</span> <span class="o">==</span> <span class="s2">&quot;deeplabcut&quot;</span><span class="p">:</span>
            <span class="n">setup_project</span><span class="p">(</span>
                <span class="n">project_dir</span><span class="o">=</span><span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="n">deeplabcut_config</span><span class="o">=</span><span class="p">(</span><span class="n">kpset_dir</span> <span class="o">/</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">kpset_dir</span> <span class="o">/</span> <span class="s2">&quot;config.yml&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Currently, `deeplabcut` is the only pose estimation method supported by this Element. Please reach out at `support@datajoint.com` if you use another method.&quot;</span>
            <span class="p">)</span>

        <span class="n">kpms_config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span>
            <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">check_if_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">build_indexes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">kpms_dj_config_kwargs_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">video_dir</span><span class="o">=</span><span class="n">videos_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">anterior_bodyparts</span><span class="o">=</span><span class="n">anterior_bodyparts</span><span class="p">,</span>
            <span class="n">posterior_bodyparts</span><span class="o">=</span><span class="n">posterior_bodyparts</span><span class="p">,</span>
            <span class="n">use_bodyparts</span><span class="o">=</span><span class="n">use_bodyparts</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">kpms_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kpms_dj_config_kwargs_dict</span><span class="p">)</span>
        <span class="n">kpms_reader</span><span class="o">.</span><span class="n">generate_kpms_dj_config</span><span class="p">(</span>
            <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="o">**</span><span class="n">kpms_config</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span>
            <span class="n">kpms_processed</span><span class="p">,</span> <span class="n">kpms_project_output_dir</span>
        <span class="p">)</span>
        <span class="n">kpset_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span><span class="n">kpms_root</span><span class="p">,</span> <span class="n">kpset_dir</span><span class="p">)</span>
        <span class="n">videos_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span><span class="n">kpms_root</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">video_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

    <span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span><span class="p">,</span> <span class="n">formatted_bodyparts</span> <span class="o">=</span> <span class="n">load_keypoints</span><span class="p">(</span>
        <span class="n">filepath_pattern</span><span class="o">=</span><span class="n">kpset_dir</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">pose_estimation_method</span>
    <span class="p">)</span>

    <span class="n">frame_rate_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fp</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">video_paths</span><span class="p">,</span> <span class="n">video_ids</span><span class="p">):</span>
        <span class="n">video_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">find_full_path</span><span class="p">(</span><span class="n">kpms_root</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
        <span class="n">frame_rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)))</span>
        <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">average_frame_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">frame_rate_list</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="o">**</span><span class="n">key</span><span class="p">,</span>
            <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
            <span class="n">confidences</span><span class="o">=</span><span class="n">confidences</span><span class="p">,</span>
            <span class="n">formatted_bodyparts</span><span class="o">=</span><span class="n">formatted_bodyparts</span><span class="p">,</span>
            <span class="n">average_frame_rate</span><span class="o">=</span><span class="n">average_frame_rate</span><span class="p">,</span>
            <span class="n">frame_rates</span><span class="o">=</span><span class="n">frame_rate_list</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_train.PCAFit" class="doc doc-heading">
            <code>PCAFit</code>


<a href="#element_moseq.moseq_train.PCAFit" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Computed">Computed</span></code></p>


        <p>Fit PCA model.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PCAFit.PCAPrep">PCAPrep</span></code></td>
            <td>
                  <code>foreign key)           </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>PCAPrep</code> Key.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PCAFit.pca_fit_time">pca_fit_time</span></code></td>
            <td>
                  <code>datetime)         </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>datetime of the PCA fitting analysis.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PCAFit</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit PCA model.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        PCAPrep (foreign key)           : `PCAPrep` Key.</span>
<span class="sd">        pca_fit_time (datetime)         : datetime of the PCA fitting analysis.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; PCAPrep                           # `PCAPrep` Key</span>
<span class="s2">    ---</span>
<span class="s2">    pca_fit_time=NULL        : datetime  # datetime of the PCA fitting analysis</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make function to format the keypoint data, fit the PCA model, and store it as a `pca.p` file in the Keypoint-MoSeq project output directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (dict): `PCAPrep` Key</span>

<span class="sd">        Raises:</span>

<span class="sd">        High-Level Logic:</span>
<span class="sd">        1. Fetch the `kpms_project_output_dir` from the `PCATask` table and define its full path.</span>
<span class="sd">        2. Load the `kpms_dj_config` file that contains the updated `video_dir` and bodyparts, \</span>
<span class="sd">           and format the keypoint data with the coordinates and confidences scores to be used in the PCA fitting.</span>
<span class="sd">        3. Fit the PCA model and save it as `pca.p` file in the output directory.</span>
<span class="sd">        4.Insert the creation datetime as the `pca_fit_time` into the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="n">format_data</span><span class="p">,</span> <span class="n">fit_pca</span><span class="p">,</span> <span class="n">save_pca</span>

        <span class="n">kpms_project_output_dir</span><span class="p">,</span> <span class="n">task_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCATask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;kpms_project_output_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;task_mode&quot;</span>
        <span class="p">)</span>
        <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">moseq_infer</span><span class="o">.</span><span class="n">get_kpms_processed_data_dir</span><span class="p">()</span> <span class="o">/</span> <span class="n">kpms_project_output_dir</span>
        <span class="p">)</span>

        <span class="n">kpms_default_config</span> <span class="o">=</span> <span class="n">kpms_reader</span><span class="o">.</span><span class="n">load_kpms_dj_config</span><span class="p">(</span>
            <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="n">check_if_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">build_indexes</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCAPrep</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="s2">&quot;confidences&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">format_data</span><span class="p">(</span>
            <span class="o">**</span><span class="n">kpms_default_config</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span><span class="o">=</span><span class="n">confidences</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
            <span class="n">pca</span> <span class="o">=</span> <span class="n">fit_pca</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kpms_default_config</span><span class="p">)</span>
            <span class="n">save_pca</span><span class="p">(</span><span class="n">pca</span><span class="p">,</span> <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="n">creation_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">creation_datetime</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="n">pca_fit_time</span><span class="o">=</span><span class="n">creation_datetime</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-function">


<h3 id="element_moseq.moseq_train.PCAFit.make" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#element_moseq.moseq_train.PCAFit.make" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Make function to format the keypoint data, fit the PCA model, and store it as a <code>pca.p</code> file in the Keypoint-MoSeq project output directory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>PCAPrep</code> Key</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Raises:</p>
<p>High-Level Logic:
1. Fetch the <code>kpms_project_output_dir</code> from the <code>PCATask</code> table and define its full path.
2. Load the <code>kpms_dj_config</code> file that contains the updated <code>video_dir</code> and bodyparts,            and format the keypoint data with the coordinates and confidences scores to be used in the PCA fitting.
3. Fit the PCA model and save it as <code>pca.p</code> file in the output directory.
4.Insert the creation datetime as the <code>pca_fit_time</code> into the table.</p>

            <details class="quote">
              <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make function to format the keypoint data, fit the PCA model, and store it as a `pca.p` file in the Keypoint-MoSeq project output directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (dict): `PCAPrep` Key</span>

<span class="sd">    Raises:</span>

<span class="sd">    High-Level Logic:</span>
<span class="sd">    1. Fetch the `kpms_project_output_dir` from the `PCATask` table and define its full path.</span>
<span class="sd">    2. Load the `kpms_dj_config` file that contains the updated `video_dir` and bodyparts, \</span>
<span class="sd">       and format the keypoint data with the coordinates and confidences scores to be used in the PCA fitting.</span>
<span class="sd">    3. Fit the PCA model and save it as `pca.p` file in the output directory.</span>
<span class="sd">    4.Insert the creation datetime as the `pca_fit_time` into the table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="n">format_data</span><span class="p">,</span> <span class="n">fit_pca</span><span class="p">,</span> <span class="n">save_pca</span>

    <span class="n">kpms_project_output_dir</span><span class="p">,</span> <span class="n">task_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCATask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
        <span class="s2">&quot;kpms_project_output_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;task_mode&quot;</span>
    <span class="p">)</span>
    <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">moseq_infer</span><span class="o">.</span><span class="n">get_kpms_processed_data_dir</span><span class="p">()</span> <span class="o">/</span> <span class="n">kpms_project_output_dir</span>
    <span class="p">)</span>

    <span class="n">kpms_default_config</span> <span class="o">=</span> <span class="n">kpms_reader</span><span class="o">.</span><span class="n">load_kpms_dj_config</span><span class="p">(</span>
        <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="n">check_if_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">build_indexes</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCAPrep</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="s2">&quot;confidences&quot;</span><span class="p">)</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">format_data</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kpms_default_config</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span><span class="o">=</span><span class="n">confidences</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
        <span class="n">pca</span> <span class="o">=</span> <span class="n">fit_pca</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kpms_default_config</span><span class="p">)</span>
        <span class="n">save_pca</span><span class="p">(</span><span class="n">pca</span><span class="p">,</span> <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
        <span class="n">creation_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">creation_datetime</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="n">pca_fit_time</span><span class="o">=</span><span class="n">creation_datetime</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_train.LatentDimension" class="doc doc-heading">
            <code>LatentDimension</code>


<a href="#element_moseq.moseq_train.LatentDimension" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Imported">Imported</span></code></p>


        <p>Determine the latent dimension as part of the autoregressive hyperparameters (<code>ar_hypparams</code>) for the model fitting.
The objective of the analysis is to inform the user about the number of principal components needed to explain a
90% variance threshold. Subsequently, the decision on how many components to utilize for the model fitting is left
to the user.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.LatentDimension.PCAFit">PCAFit</span></code></td>
            <td>
                  <code>foreign key)               </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>PCAFit</code> Key.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.LatentDimension.variance_percentage">variance_percentage</span></code></td>
            <td>
                  <code>float)        </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Variance threshold. Fixed value to 90%.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.LatentDimension.latent_dimension">latent_dimension</span></code></td>
            <td>
                  <code>int)             </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of principal components required to explain the specified variance.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.LatentDimension.latent_dim_desc">latent_dim_desc</span></code></td>
            <td>
                  <code>varchar)          </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Automated description of the computation result.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LatentDimension</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Imported</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the latent dimension as part of the autoregressive hyperparameters (`ar_hypparams`) for the model fitting.</span>
<span class="sd">    The objective of the analysis is to inform the user about the number of principal components needed to explain a</span>
<span class="sd">    90% variance threshold. Subsequently, the decision on how many components to utilize for the model fitting is left</span>
<span class="sd">    to the user.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        PCAFit (foreign key)               : `PCAFit` Key.</span>
<span class="sd">        variance_percentage (float)        : Variance threshold. Fixed value to 90%.</span>
<span class="sd">        latent_dimension (int)             : Number of principal components required to explain the specified variance.</span>
<span class="sd">        latent_dim_desc (varchar)          : Automated description of the computation result.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; PCAFit                                   # `PCAFit` Key</span>
<span class="s2">    ---</span>
<span class="s2">    variance_percentage      : float            # Variance threshold. Fixed value to 90 percent.</span>
<span class="s2">    latent_dimension         : int              # Number of principal components required to explain the specified variance.</span>
<span class="s2">    latent_dim_desc          : varchar(1000)    # Automated description of the computation result.</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make function to compute and store the latent dimension that explains a 90% variance threshold.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (dict): `PCAFit` Key.</span>

<span class="sd">        Raises:</span>

<span class="sd">        High-Level Logic:</span>
<span class="sd">        1. Fetches the Keypoint-MoSeq project output directory from the PCATask table and define the full path.</span>
<span class="sd">        2. Load the PCA model from file in this directory.</span>
<span class="sd">        2. Set a specified variance threshold to 90% and compute the cumulative sum of the explained variance ratio.</span>
<span class="sd">        3. Determine the number of components required to explain the specified variance.</span>
<span class="sd">            3.1 If the cumulative sum of the explained variance ratio is less than the specified variance threshold, \</span>
<span class="sd">                it sets the `latent_dimension` to the total number of components and `variance_percentage` to the cumulative sum of the explained variance ratio.</span>
<span class="sd">            3.2 If the cumulative sum of the explained variance ratio is greater than the specified variance threshold, \</span>
<span class="sd">                it sets the `latent_dimension` to the number of components that explain the specified variance and `variance_percentage` to the specified variance threshold.</span>
<span class="sd">        4. Insert the results of this `make` function into the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_pca</span>

        <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCATask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;kpms_project_output_dir&quot;</span><span class="p">)</span>
        <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">moseq_infer</span><span class="o">.</span><span class="n">get_kpms_processed_data_dir</span><span class="p">()</span> <span class="o">/</span> <span class="n">kpms_project_output_dir</span>
        <span class="p">)</span>

        <span class="n">pca_path</span> <span class="o">=</span> <span class="n">kpms_project_output_dir</span> <span class="o">/</span> <span class="s2">&quot;pca.p&quot;</span>
        <span class="k">if</span> <span class="n">pca_path</span><span class="p">:</span>
            <span class="n">pca</span> <span class="o">=</span> <span class="n">load_pca</span><span class="p">(</span><span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No pca model (`pca.p`) found in the project directory </span><span class="si">{</span><span class="n">kpms_project_output_dir</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">variance_threshold</span> <span class="o">=</span> <span class="mf">0.90</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
            <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>
        <span class="p">)</span>  <span class="c1"># explained_variance_ratio_ndarray of shape (n_components,)</span>

        <span class="k">if</span> <span class="n">cs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">variance_threshold</span><span class="p">:</span>
            <span class="n">latent_dimension</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
            <span class="n">variance_percentage</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">latent_dim_desc</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;All components together only explain </span><span class="si">{</span><span class="n">cs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">% of variance.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">latent_dimension</span> <span class="o">=</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&gt;</span> <span class="n">variance_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">variance_percentage</span> <span class="o">=</span> <span class="n">variance_threshold</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">latent_dim_desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&gt;=</span><span class="si">{</span><span class="n">variance_threshold</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">% of variance explained by </span><span class="si">{</span><span class="p">(</span><span class="n">cs</span><span class="o">&gt;</span><span class="n">variance_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> components.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                <span class="n">variance_percentage</span><span class="o">=</span><span class="n">variance_percentage</span><span class="p">,</span>
                <span class="n">latent_dimension</span><span class="o">=</span><span class="n">latent_dimension</span><span class="p">,</span>
                <span class="n">latent_dim_desc</span><span class="o">=</span><span class="n">latent_dim_desc</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-function">


<h3 id="element_moseq.moseq_train.LatentDimension.make" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#element_moseq.moseq_train.LatentDimension.make" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Make function to compute and store the latent dimension that explains a 90% variance threshold.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>PCAFit</code> Key.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Raises:</p>
<p>High-Level Logic:
1. Fetches the Keypoint-MoSeq project output directory from the PCATask table and define the full path.
2. Load the PCA model from file in this directory.
2. Set a specified variance threshold to 90% and compute the cumulative sum of the explained variance ratio.
3. Determine the number of components required to explain the specified variance.
    3.1 If the cumulative sum of the explained variance ratio is less than the specified variance threshold,                 it sets the <code>latent_dimension</code> to the total number of components and <code>variance_percentage</code> to the cumulative sum of the explained variance ratio.
    3.2 If the cumulative sum of the explained variance ratio is greater than the specified variance threshold,                 it sets the <code>latent_dimension</code> to the number of components that explain the specified variance and <code>variance_percentage</code> to the specified variance threshold.
4. Insert the results of this <code>make</code> function into the table.</p>

            <details class="quote">
              <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make function to compute and store the latent dimension that explains a 90% variance threshold.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (dict): `PCAFit` Key.</span>

<span class="sd">    Raises:</span>

<span class="sd">    High-Level Logic:</span>
<span class="sd">    1. Fetches the Keypoint-MoSeq project output directory from the PCATask table and define the full path.</span>
<span class="sd">    2. Load the PCA model from file in this directory.</span>
<span class="sd">    2. Set a specified variance threshold to 90% and compute the cumulative sum of the explained variance ratio.</span>
<span class="sd">    3. Determine the number of components required to explain the specified variance.</span>
<span class="sd">        3.1 If the cumulative sum of the explained variance ratio is less than the specified variance threshold, \</span>
<span class="sd">            it sets the `latent_dimension` to the total number of components and `variance_percentage` to the cumulative sum of the explained variance ratio.</span>
<span class="sd">        3.2 If the cumulative sum of the explained variance ratio is greater than the specified variance threshold, \</span>
<span class="sd">            it sets the `latent_dimension` to the number of components that explain the specified variance and `variance_percentage` to the specified variance threshold.</span>
<span class="sd">    4. Insert the results of this `make` function into the table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_pca</span>

    <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCATask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;kpms_project_output_dir&quot;</span><span class="p">)</span>
    <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">moseq_infer</span><span class="o">.</span><span class="n">get_kpms_processed_data_dir</span><span class="p">()</span> <span class="o">/</span> <span class="n">kpms_project_output_dir</span>
    <span class="p">)</span>

    <span class="n">pca_path</span> <span class="o">=</span> <span class="n">kpms_project_output_dir</span> <span class="o">/</span> <span class="s2">&quot;pca.p&quot;</span>
    <span class="k">if</span> <span class="n">pca_path</span><span class="p">:</span>
        <span class="n">pca</span> <span class="o">=</span> <span class="n">load_pca</span><span class="p">(</span><span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No pca model (`pca.p`) found in the project directory </span><span class="si">{</span><span class="n">kpms_project_output_dir</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">variance_threshold</span> <span class="o">=</span> <span class="mf">0.90</span>

    <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
        <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>
    <span class="p">)</span>  <span class="c1"># explained_variance_ratio_ndarray of shape (n_components,)</span>

    <span class="k">if</span> <span class="n">cs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">variance_threshold</span><span class="p">:</span>
        <span class="n">latent_dimension</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="n">variance_percentage</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">latent_dim_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;All components together only explain </span><span class="si">{</span><span class="n">cs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">% of variance.&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">latent_dimension</span> <span class="o">=</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&gt;</span> <span class="n">variance_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">variance_percentage</span> <span class="o">=</span> <span class="n">variance_threshold</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">latent_dim_desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&gt;=</span><span class="si">{</span><span class="n">variance_threshold</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">% of variance explained by </span><span class="si">{</span><span class="p">(</span><span class="n">cs</span><span class="o">&gt;</span><span class="n">variance_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> components.&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="o">**</span><span class="n">key</span><span class="p">,</span>
            <span class="n">variance_percentage</span><span class="o">=</span><span class="n">variance_percentage</span><span class="p">,</span>
            <span class="n">latent_dimension</span><span class="o">=</span><span class="n">latent_dimension</span><span class="p">,</span>
            <span class="n">latent_dim_desc</span><span class="o">=</span><span class="n">latent_dim_desc</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_train.PreFitTask" class="doc doc-heading">
            <code>PreFitTask</code>


<a href="#element_moseq.moseq_train.PreFitTask" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Manual">Manual</span></code></p>


        <p>Insert the parameters for the model (AR-HMM) pre-fitting.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PreFitTask.PCAFit">PCAFit</span></code></td>
            <td>
                  <code>foreign key)                </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>PCAFit</code> task.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PreFitTask.pre_latent_dim">pre_latent_dim</span></code></td>
            <td>
                  <code>int)                </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Latent dimension to use for the model pre-fitting.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PreFitTask.pre_kappa">pre_kappa</span></code></td>
            <td>
                  <code>int)                     </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Kappa value to use for the model pre-fitting.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PreFitTask.pre_num_iterations">pre_num_iterations</span></code></td>
            <td>
                  <code>int)            </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of Gibbs sampling iterations to run in the model pre-fitting.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PreFitTask.pre_fit_desc(varchar)">pre_fit_desc(varchar)</span></code></td>
            <td>
                  <code>              </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>User-defined description of the pre-fitting task.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PreFitTask</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Insert the parameters for the model (AR-HMM) pre-fitting.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        PCAFit (foreign key)                : `PCAFit` task.</span>
<span class="sd">        pre_latent_dim (int)                : Latent dimension to use for the model pre-fitting.</span>
<span class="sd">        pre_kappa (int)                     : Kappa value to use for the model pre-fitting.</span>
<span class="sd">        pre_num_iterations (int)            : Number of Gibbs sampling iterations to run in the model pre-fitting.</span>
<span class="sd">        pre_fit_desc(varchar)               : User-defined description of the pre-fitting task.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; PCAFit                                           # `PCAFit` Key</span>
<span class="s2">    pre_latent_dim               : int                  # Latent dimension to use for the model pre-fitting</span>
<span class="s2">    pre_kappa                    : int                  # Kappa value to use for the model pre-fitting</span>
<span class="s2">    pre_num_iterations           : int                  # Number of Gibbs sampling iterations to run in the model pre-fitting</span>
<span class="s2">    ---</span>
<span class="s2">    model_name                   : varchar(100)         # Name of the model to be loaded if `task_mode=&#39;load&#39;`</span>
<span class="s2">    task_mode=&#39;load&#39;             :enum(&#39;trigger&#39;,&#39;load&#39;)# &#39;load&#39;: load computed analysis results, &#39;trigger&#39;: trigger computation</span>
<span class="s2">    pre_fit_desc=&#39;&#39;              : varchar(1000)        # User-defined description of the pre-fitting task</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_train.PreFit" class="doc doc-heading">
            <code>PreFit</code>


<a href="#element_moseq.moseq_train.PreFit" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Computed">Computed</span></code></p>


        <p>Fit AR-HMM model.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PreFit.PreFitTask">PreFitTask</span></code></td>
            <td>
                  <code>foreign key)                </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>PreFitTask</code> Key.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PreFit.model_name">model_name</span></code></td>
            <td>
                  <code>varchar)                    </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the model as "kpms_project_output_dir/model_name".</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.PreFit.pre_fit_duration">pre_fit_duration</span></code></td>
            <td>
                  <code>float)                </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time duration (seconds) of the model fitting computation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PreFit</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit AR-HMM model.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        PreFitTask (foreign key)                : `PreFitTask` Key.</span>
<span class="sd">        model_name (varchar)                    : Name of the model as &quot;kpms_project_output_dir/model_name&quot;.</span>
<span class="sd">        pre_fit_duration (float)                : Time duration (seconds) of the model fitting computation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; PreFitTask                               # `PreFitTask` Key</span>
<span class="s2">    ---</span>
<span class="s2">    model_name=&#39;&#39;                : varchar(100) # Name of the model as &quot;kpms_project_output_dir/model_name&quot;</span>
<span class="s2">    pre_fit_duration=NULL        : float        # Time duration (seconds) of the model fitting computation</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make function to fit the AR-HMM model using the latent trajectory defined by `model[&#39;states&#39;][&#39;x&#39;].</span>

<span class="sd">        Args:</span>
<span class="sd">            key (dict) : dictionary with the `PreFitTask` Key.</span>

<span class="sd">        Raises:</span>

<span class="sd">        High-level Logic:</span>
<span class="sd">        1. Fetch the `kpms_project_output_dir` and define the full path.</span>
<span class="sd">        2. Fetch the model parameters from the `PreFitTask` table.</span>
<span class="sd">        3. Update the `dj_config.yml` with the latent dimension and kappa for the AR-HMM fitting.</span>
<span class="sd">        4. Load the pca model from file in the `kpms_project_output_dir`.</span>
<span class="sd">        5. Fetch `coordinates` and `confidences` scores to format the data for the model initialization. \</span>
<span class="sd">            # Data - contains the data for model fitting. \</span>
<span class="sd">            # Metadata - contains the recordings and start/end frames for the data.</span>
<span class="sd">        6. Initialize the model that create a `model` dict containing states, parameters, hyperparameters, noise prior, and random seed.</span>
<span class="sd">        7. Update the model dict with the selected kappa for the AR-HMM fitting.</span>
<span class="sd">        8. Fit the AR-HMM model using the `pre_num_iterations` and create a subdirectory in `kpms_project_output_dir` with the model&#39;s latest checkpoint file.</span>
<span class="sd">        9. Calculate the duration of the model fitting computation and insert it in the `PreFit` table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">load_pca</span><span class="p">,</span>
            <span class="n">format_data</span><span class="p">,</span>
            <span class="n">init_model</span><span class="p">,</span>
            <span class="n">update_hypparams</span><span class="p">,</span>
            <span class="n">fit_model</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">kpms_processed</span> <span class="o">=</span> <span class="n">moseq_infer</span><span class="o">.</span><span class="n">get_kpms_processed_data_dir</span><span class="p">()</span>

        <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span>
            <span class="n">kpms_processed</span><span class="p">,</span> <span class="p">(</span><span class="n">PCATask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;kpms_project_output_dir&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">pre_latent_dim</span><span class="p">,</span> <span class="n">pre_kappa</span><span class="p">,</span> <span class="n">pre_num_iterations</span><span class="p">,</span> <span class="n">task_mode</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">PreFitTask</span> <span class="o">&amp;</span> <span class="n">key</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;pre_latent_dim&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pre_kappa&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pre_num_iterations&quot;</span><span class="p">,</span>
            <span class="s2">&quot;task_mode&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model_name&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
            <span class="n">kpms_dj_config</span> <span class="o">=</span> <span class="n">kpms_reader</span><span class="o">.</span><span class="n">load_kpms_dj_config</span><span class="p">(</span>
                <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="n">check_if_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">build_indexes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">kpms_dj_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">latent_dim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">pre_latent_dim</span><span class="p">),</span> <span class="n">kappa</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">pre_kappa</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">kpms_reader</span><span class="o">.</span><span class="n">generate_kpms_dj_config</span><span class="p">(</span>
                <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="o">**</span><span class="n">kpms_dj_config</span>
            <span class="p">)</span>

            <span class="n">pca_path</span> <span class="o">=</span> <span class="n">kpms_project_output_dir</span> <span class="o">/</span> <span class="s2">&quot;pca.p&quot;</span>
            <span class="k">if</span> <span class="n">pca_path</span><span class="p">:</span>
                <span class="n">pca</span> <span class="o">=</span> <span class="n">load_pca</span><span class="p">(</span><span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No pca model (`pca.p`) found in the project directory </span><span class="si">{</span><span class="n">kpms_project_output_dir</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCAPrep</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
                <span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="s2">&quot;confidences&quot;</span>
            <span class="p">)</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">format_data</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span><span class="p">,</span> <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">)</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">init_model</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pca</span><span class="o">=</span><span class="n">pca</span><span class="p">,</span> <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">)</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">update_hypparams</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">pre_kappa</span><span class="p">),</span> <span class="n">latent_dim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">pre_latent_dim</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="n">fit_model</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">project_dir</span><span class="o">=</span><span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="n">ar_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">num_iters</span><span class="o">=</span><span class="n">pre_num_iterations</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="n">duration_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">duration_seconds</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">kpms_processed</span><span class="p">)</span> <span class="o">/</span> <span class="n">model_name</span>
                <span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="s2">&quot;pre_fit_duration&quot;</span><span class="p">:</span> <span class="n">duration_seconds</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-function">


<h3 id="element_moseq.moseq_train.PreFit.make" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#element_moseq.moseq_train.PreFit.make" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Make function to fit the AR-HMM model using the latent trajectory defined by `model['states']['x'].</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code>dict) </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dictionary with the <code>PreFitTask</code> Key.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Raises:</p>
<p>High-level Logic:
1. Fetch the <code>kpms_project_output_dir</code> and define the full path.
2. Fetch the model parameters from the <code>PreFitTask</code> table.
3. Update the <code>dj_config.yml</code> with the latent dimension and kappa for the AR-HMM fitting.
4. Load the pca model from file in the <code>kpms_project_output_dir</code>.
5. Fetch <code>coordinates</code> and <code>confidences</code> scores to format the data for the model initialization.             # Data - contains the data for model fitting.             # Metadata - contains the recordings and start/end frames for the data.
6. Initialize the model that create a <code>model</code> dict containing states, parameters, hyperparameters, noise prior, and random seed.
7. Update the model dict with the selected kappa for the AR-HMM fitting.
8. Fit the AR-HMM model using the <code>pre_num_iterations</code> and create a subdirectory in <code>kpms_project_output_dir</code> with the model's latest checkpoint file.
9. Calculate the duration of the model fitting computation and insert it in the <code>PreFit</code> table.</p>

            <details class="quote">
              <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make function to fit the AR-HMM model using the latent trajectory defined by `model[&#39;states&#39;][&#39;x&#39;].</span>

<span class="sd">    Args:</span>
<span class="sd">        key (dict) : dictionary with the `PreFitTask` Key.</span>

<span class="sd">    Raises:</span>

<span class="sd">    High-level Logic:</span>
<span class="sd">    1. Fetch the `kpms_project_output_dir` and define the full path.</span>
<span class="sd">    2. Fetch the model parameters from the `PreFitTask` table.</span>
<span class="sd">    3. Update the `dj_config.yml` with the latent dimension and kappa for the AR-HMM fitting.</span>
<span class="sd">    4. Load the pca model from file in the `kpms_project_output_dir`.</span>
<span class="sd">    5. Fetch `coordinates` and `confidences` scores to format the data for the model initialization. \</span>
<span class="sd">        # Data - contains the data for model fitting. \</span>
<span class="sd">        # Metadata - contains the recordings and start/end frames for the data.</span>
<span class="sd">    6. Initialize the model that create a `model` dict containing states, parameters, hyperparameters, noise prior, and random seed.</span>
<span class="sd">    7. Update the model dict with the selected kappa for the AR-HMM fitting.</span>
<span class="sd">    8. Fit the AR-HMM model using the `pre_num_iterations` and create a subdirectory in `kpms_project_output_dir` with the model&#39;s latest checkpoint file.</span>
<span class="sd">    9. Calculate the duration of the model fitting computation and insert it in the `PreFit` table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">load_pca</span><span class="p">,</span>
        <span class="n">format_data</span><span class="p">,</span>
        <span class="n">init_model</span><span class="p">,</span>
        <span class="n">update_hypparams</span><span class="p">,</span>
        <span class="n">fit_model</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">kpms_processed</span> <span class="o">=</span> <span class="n">moseq_infer</span><span class="o">.</span><span class="n">get_kpms_processed_data_dir</span><span class="p">()</span>

    <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span>
        <span class="n">kpms_processed</span><span class="p">,</span> <span class="p">(</span><span class="n">PCATask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;kpms_project_output_dir&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">pre_latent_dim</span><span class="p">,</span> <span class="n">pre_kappa</span><span class="p">,</span> <span class="n">pre_num_iterations</span><span class="p">,</span> <span class="n">task_mode</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">PreFitTask</span> <span class="o">&amp;</span> <span class="n">key</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
        <span class="s2">&quot;pre_latent_dim&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pre_kappa&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pre_num_iterations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;task_mode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;model_name&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
        <span class="n">kpms_dj_config</span> <span class="o">=</span> <span class="n">kpms_reader</span><span class="o">.</span><span class="n">load_kpms_dj_config</span><span class="p">(</span>
            <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">check_if_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">build_indexes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">kpms_dj_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">latent_dim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">pre_latent_dim</span><span class="p">),</span> <span class="n">kappa</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">pre_kappa</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">kpms_reader</span><span class="o">.</span><span class="n">generate_kpms_dj_config</span><span class="p">(</span>
            <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="o">**</span><span class="n">kpms_dj_config</span>
        <span class="p">)</span>

        <span class="n">pca_path</span> <span class="o">=</span> <span class="n">kpms_project_output_dir</span> <span class="o">/</span> <span class="s2">&quot;pca.p&quot;</span>
        <span class="k">if</span> <span class="n">pca_path</span><span class="p">:</span>
            <span class="n">pca</span> <span class="o">=</span> <span class="n">load_pca</span><span class="p">(</span><span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No pca model (`pca.p`) found in the project directory </span><span class="si">{</span><span class="n">kpms_project_output_dir</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCAPrep</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="s2">&quot;confidences&quot;</span>
        <span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">format_data</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span><span class="p">,</span> <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">init_model</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pca</span><span class="o">=</span><span class="n">pca</span><span class="p">,</span> <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">update_hypparams</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">pre_kappa</span><span class="p">),</span> <span class="n">latent_dim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">pre_latent_dim</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="n">fit_model</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">project_dir</span><span class="o">=</span><span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">ar_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">num_iters</span><span class="o">=</span><span class="n">pre_num_iterations</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">duration_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">duration_seconds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="o">**</span><span class="n">key</span><span class="p">,</span>
            <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">kpms_processed</span><span class="p">)</span> <span class="o">/</span> <span class="n">model_name</span>
            <span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="s2">&quot;pre_fit_duration&quot;</span><span class="p">:</span> <span class="n">duration_seconds</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_train.FullFitTask" class="doc doc-heading">
            <code>FullFitTask</code>


<a href="#element_moseq.moseq_train.FullFitTask" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Manual">Manual</span></code></p>


        <p>Insert the parameters for the full (Keypoint-SLDS model) fitting.
   The full model will generally require a lower value of kappa to yield the same target syllable durations.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.FullFitTask.PCAFit">PCAFit</span></code></td>
            <td>
                  <code>foreign key)                 </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>PCAFit</code> Key.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.FullFitTask.full_latent_dim">full_latent_dim</span></code></td>
            <td>
                  <code>int)                </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Latent dimension to use for the model full fitting.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.FullFitTask.full_kappa">full_kappa</span></code></td>
            <td>
                  <code>int)                     </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Kappa value to use for the model full fitting.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.FullFitTask.full_num_iterations">full_num_iterations</span></code></td>
            <td>
                  <code>int)            </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of Gibbs sampling iterations to run in the model full fitting.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.FullFitTask.full_fit_desc(varchar)">full_fit_desc(varchar)</span></code></td>
            <td>
                  <code>              </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>User-defined description of the model full fitting task.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FullFitTask</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Insert the parameters for the full (Keypoint-SLDS model) fitting.</span>
<span class="sd">       The full model will generally require a lower value of kappa to yield the same target syllable durations.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        PCAFit (foreign key)                 : `PCAFit` Key.</span>
<span class="sd">        full_latent_dim (int)                : Latent dimension to use for the model full fitting.</span>
<span class="sd">        full_kappa (int)                     : Kappa value to use for the model full fitting.</span>
<span class="sd">        full_num_iterations (int)            : Number of Gibbs sampling iterations to run in the model full fitting.</span>
<span class="sd">        full_fit_desc(varchar)               : User-defined description of the model full fitting task.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; PCAFit                                           # `PCAFit` Key</span>
<span class="s2">    full_latent_dim              : int                  # Latent dimension to use for the model full fitting</span>
<span class="s2">    full_kappa                   : int                  # Kappa value to use for the model full fitting</span>
<span class="s2">    full_num_iterations          : int                  # Number of Gibbs sampling iterations to run in the model full fitting</span>
<span class="s2">    ---</span>
<span class="s2">    model_name                   : varchar(100)         # Name of the model to be loaded if `task_mode=&#39;load&#39;`</span>
<span class="s2">    task_mode=&#39;load&#39;             :enum(&#39;load&#39;,&#39;trigger&#39;)# Trigger or load the task</span>
<span class="s2">    full_fit_desc=&#39;&#39;             : varchar(1000)        # User-defined description of the model full fitting task   </span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">





  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_moseq.moseq_train.FullFit" class="doc doc-heading">
            <code>FullFit</code>


<a href="#element_moseq.moseq_train.FullFit" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="datajoint.Computed">Computed</span></code></p>


        <p>Fit the full (Keypoint-SLDS) model.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.FullFit.FullFitTask">FullFitTask</span></code></td>
            <td>
                  <code>foreign key)            </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>FullFitTask</code> Key.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.FullFit.model_name">model_name</span></code></td>
            <td>
                  <code>                          </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>varchar(100) # Name of the model as "kpms_project_output_dir/model_name"</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="element_moseq.moseq_train.FullFit.full_fit_duration">full_fit_duration</span></code></td>
            <td>
                  <code>float)            </code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time duration (seconds) of the full fitting computation</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FullFit</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit the full (Keypoint-SLDS) model.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        FullFitTask (foreign key)            : `FullFitTask` Key.</span>
<span class="sd">        model_name                           : varchar(100) # Name of the model as &quot;kpms_project_output_dir/model_name&quot;</span>
<span class="sd">        full_fit_duration (float)            : Time duration (seconds) of the full fitting computation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; FullFitTask                               # `FullFitTask` Key</span>
<span class="s2">    ---</span>
<span class="s2">    model_name                    : varchar(100) # Name of the model as &quot;kpms_project_output_dir/model_name&quot;</span>
<span class="s2">    full_fit_duration=NULL        : float        # Time duration (seconds) of the full fitting computation </span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Make function to fit the full (keypoint-SLDS) model</span>

<span class="sd">            Args:</span>
<span class="sd">                key (dict): dictionary with the `FullFitTask` Key.</span>

<span class="sd">            Raises:</span>

<span class="sd">            High-level Logic:</span>
<span class="sd">            1. Fetch the `kpms_project_output_dir` and define the full path.</span>
<span class="sd">            2. Fetch the model parameters from the `FullFitTask` table.</span>
<span class="sd">            2. Update the `dj_config.yml` with the selected latent dimension and kappa for the full-fitting.</span>
<span class="sd">            3. Initialize and fit the full model in a new `model_name` directory.</span>
<span class="sd">            4. Load the pca model from file in the `kpms_project_output_dir`.</span>
<span class="sd">            5. Fetch the `coordinates` and `confidences` scores to format the data for the model initialization.</span>
<span class="sd">            6. Initialize the model that create a `model` dict containing states, parameters, hyperparameters, noise prior, and random seed.</span>
<span class="sd">            7. Update the model dict with the selected kappa for the Keypoint-SLDS fitting.</span>
<span class="sd">            8. Fit the Keypoint-SLDS model using the `full_num_iterations` and create a subdirectory in `kpms_project_output_dir` with the model&#39;s latest checkpoint file.</span>
<span class="sd">            8. Reindex syllable labels by their frequency in the most recent model snapshot in the checkpoint file. \</span>
<span class="sd">                This function permutes the states and parameters of a saved checkpoint so that syllables are labeled \</span>
<span class="sd">                in order of frequency (i.e. so that 0 is the most frequent, 1 is the second most, and so on).</span>
<span class="sd">            8. Calculate the duration of the model fitting computation and insert it in the `PreFit` table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">load_pca</span><span class="p">,</span>
            <span class="n">format_data</span><span class="p">,</span>
            <span class="n">init_model</span><span class="p">,</span>
            <span class="n">update_hypparams</span><span class="p">,</span>
            <span class="n">fit_model</span><span class="p">,</span>
            <span class="n">reindex_syllables_in_checkpoint</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">kpms_processed</span> <span class="o">=</span> <span class="n">moseq_infer</span><span class="o">.</span><span class="n">get_kpms_processed_data_dir</span><span class="p">()</span>

        <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span>
            <span class="n">kpms_processed</span><span class="p">,</span> <span class="p">(</span><span class="n">PCATask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;kpms_project_output_dir&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">full_latent_dim</span><span class="p">,</span> <span class="n">full_kappa</span><span class="p">,</span> <span class="n">full_num_iterations</span><span class="p">,</span> <span class="n">task_mode</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">FullFitTask</span> <span class="o">&amp;</span> <span class="n">key</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;full_latent_dim&quot;</span><span class="p">,</span>
            <span class="s2">&quot;full_kappa&quot;</span><span class="p">,</span>
            <span class="s2">&quot;full_num_iterations&quot;</span><span class="p">,</span>
            <span class="s2">&quot;task_mode&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model_name&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
            <span class="n">kpms_dj_config</span> <span class="o">=</span> <span class="n">kpms_reader</span><span class="o">.</span><span class="n">load_kpms_dj_config</span><span class="p">(</span>
                <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="n">check_if_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">build_indexes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">kpms_dj_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">latent_dim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">full_latent_dim</span><span class="p">),</span> <span class="n">kappa</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">full_kappa</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">kpms_reader</span><span class="o">.</span><span class="n">generate_kpms_dj_config</span><span class="p">(</span>
                <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="o">**</span><span class="n">kpms_dj_config</span>
            <span class="p">)</span>

            <span class="n">pca_path</span> <span class="o">=</span> <span class="n">kpms_project_output_dir</span> <span class="o">/</span> <span class="s2">&quot;pca.p&quot;</span>
            <span class="k">if</span> <span class="n">pca_path</span><span class="p">:</span>
                <span class="n">pca</span> <span class="o">=</span> <span class="n">load_pca</span><span class="p">(</span><span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No pca model (`pca.p`) found in the project directory </span><span class="si">{</span><span class="n">kpms_project_output_dir</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCAPrep</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
                <span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="s2">&quot;confidences&quot;</span>
            <span class="p">)</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">format_data</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span><span class="p">,</span> <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">init_model</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pca</span><span class="o">=</span><span class="n">pca</span><span class="p">,</span> <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">update_hypparams</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">full_kappa</span><span class="p">),</span> <span class="n">latent_dim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">full_latent_dim</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="n">fit_model</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">project_dir</span><span class="o">=</span><span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="n">ar_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">num_iters</span><span class="o">=</span><span class="n">full_num_iterations</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="n">duration_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

            <span class="n">reindex_syllables_in_checkpoint</span><span class="p">(</span>
                <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">duration_seconds</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">kpms_processed</span><span class="p">)</span> <span class="o">/</span> <span class="n">model_name</span>
                <span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="s2">&quot;full_fit_duration&quot;</span><span class="p">:</span> <span class="n">duration_seconds</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-function">


<h3 id="element_moseq.moseq_train.FullFit.make" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#element_moseq.moseq_train.FullFit.make" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Make function to fit the full (keypoint-SLDS) model</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dictionary with the <code>FullFitTask</code> Key.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Raises:</p>
<p>High-level Logic:
1. Fetch the <code>kpms_project_output_dir</code> and define the full path.
2. Fetch the model parameters from the <code>FullFitTask</code> table.
2. Update the <code>dj_config.yml</code> with the selected latent dimension and kappa for the full-fitting.
3. Initialize and fit the full model in a new <code>model_name</code> directory.
4. Load the pca model from file in the <code>kpms_project_output_dir</code>.
5. Fetch the <code>coordinates</code> and <code>confidences</code> scores to format the data for the model initialization.
6. Initialize the model that create a <code>model</code> dict containing states, parameters, hyperparameters, noise prior, and random seed.
7. Update the model dict with the selected kappa for the Keypoint-SLDS fitting.
8. Fit the Keypoint-SLDS model using the <code>full_num_iterations</code> and create a subdirectory in <code>kpms_project_output_dir</code> with the model's latest checkpoint file.
8. Reindex syllable labels by their frequency in the most recent model snapshot in the checkpoint file.                 This function permutes the states and parameters of a saved checkpoint so that syllables are labeled                 in order of frequency (i.e. so that 0 is the most frequent, 1 is the second most, and so on).
8. Calculate the duration of the model fitting computation and insert it in the <code>PreFit</code> table.</p>

            <details class="quote">
              <summary>Source code in <code>element_moseq/moseq_train.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make function to fit the full (keypoint-SLDS) model</span>

<span class="sd">        Args:</span>
<span class="sd">            key (dict): dictionary with the `FullFitTask` Key.</span>

<span class="sd">        Raises:</span>

<span class="sd">        High-level Logic:</span>
<span class="sd">        1. Fetch the `kpms_project_output_dir` and define the full path.</span>
<span class="sd">        2. Fetch the model parameters from the `FullFitTask` table.</span>
<span class="sd">        2. Update the `dj_config.yml` with the selected latent dimension and kappa for the full-fitting.</span>
<span class="sd">        3. Initialize and fit the full model in a new `model_name` directory.</span>
<span class="sd">        4. Load the pca model from file in the `kpms_project_output_dir`.</span>
<span class="sd">        5. Fetch the `coordinates` and `confidences` scores to format the data for the model initialization.</span>
<span class="sd">        6. Initialize the model that create a `model` dict containing states, parameters, hyperparameters, noise prior, and random seed.</span>
<span class="sd">        7. Update the model dict with the selected kappa for the Keypoint-SLDS fitting.</span>
<span class="sd">        8. Fit the Keypoint-SLDS model using the `full_num_iterations` and create a subdirectory in `kpms_project_output_dir` with the model&#39;s latest checkpoint file.</span>
<span class="sd">        8. Reindex syllable labels by their frequency in the most recent model snapshot in the checkpoint file. \</span>
<span class="sd">            This function permutes the states and parameters of a saved checkpoint so that syllables are labeled \</span>
<span class="sd">            in order of frequency (i.e. so that 0 is the most frequent, 1 is the second most, and so on).</span>
<span class="sd">        8. Calculate the duration of the model fitting computation and insert it in the `PreFit` table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">keypoint_moseq</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">load_pca</span><span class="p">,</span>
        <span class="n">format_data</span><span class="p">,</span>
        <span class="n">init_model</span><span class="p">,</span>
        <span class="n">update_hypparams</span><span class="p">,</span>
        <span class="n">fit_model</span><span class="p">,</span>
        <span class="n">reindex_syllables_in_checkpoint</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">kpms_processed</span> <span class="o">=</span> <span class="n">moseq_infer</span><span class="o">.</span><span class="n">get_kpms_processed_data_dir</span><span class="p">()</span>

    <span class="n">kpms_project_output_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span>
        <span class="n">kpms_processed</span><span class="p">,</span> <span class="p">(</span><span class="n">PCATask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;kpms_project_output_dir&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">full_latent_dim</span><span class="p">,</span> <span class="n">full_kappa</span><span class="p">,</span> <span class="n">full_num_iterations</span><span class="p">,</span> <span class="n">task_mode</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">FullFitTask</span> <span class="o">&amp;</span> <span class="n">key</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
        <span class="s2">&quot;full_latent_dim&quot;</span><span class="p">,</span>
        <span class="s2">&quot;full_kappa&quot;</span><span class="p">,</span>
        <span class="s2">&quot;full_num_iterations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;task_mode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;model_name&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
        <span class="n">kpms_dj_config</span> <span class="o">=</span> <span class="n">kpms_reader</span><span class="o">.</span><span class="n">load_kpms_dj_config</span><span class="p">(</span>
            <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">check_if_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">build_indexes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">kpms_dj_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">latent_dim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">full_latent_dim</span><span class="p">),</span> <span class="n">kappa</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">full_kappa</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">kpms_reader</span><span class="o">.</span><span class="n">generate_kpms_dj_config</span><span class="p">(</span>
            <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="o">**</span><span class="n">kpms_dj_config</span>
        <span class="p">)</span>

        <span class="n">pca_path</span> <span class="o">=</span> <span class="n">kpms_project_output_dir</span> <span class="o">/</span> <span class="s2">&quot;pca.p&quot;</span>
        <span class="k">if</span> <span class="n">pca_path</span><span class="p">:</span>
            <span class="n">pca</span> <span class="o">=</span> <span class="n">load_pca</span><span class="p">(</span><span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No pca model (`pca.p`) found in the project directory </span><span class="si">{</span><span class="n">kpms_project_output_dir</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCAPrep</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="s2">&quot;confidences&quot;</span>
        <span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">format_data</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">confidences</span><span class="p">,</span> <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">init_model</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pca</span><span class="o">=</span><span class="n">pca</span><span class="p">,</span> <span class="o">**</span><span class="n">kpms_dj_config</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">update_hypparams</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">full_kappa</span><span class="p">),</span> <span class="n">latent_dim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">full_latent_dim</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="n">fit_model</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">project_dir</span><span class="o">=</span><span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">ar_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_iters</span><span class="o">=</span><span class="n">full_num_iterations</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">duration_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="n">reindex_syllables_in_checkpoint</span><span class="p">(</span>
            <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="n">Path</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">duration_seconds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="o">**</span><span class="n">key</span><span class="p">,</span>
            <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">kpms_project_output_dir</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">kpms_processed</span><span class="p">)</span> <span class="o">/</span> <span class="n">model_name</span>
            <span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="s2">&quot;full_fit_duration&quot;</span><span class="p">:</span> <span class="n">duration_seconds</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://www.datajoint.com" target="_blank" rel="noopener" title="DataJoint" class="md-social__link">
      <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 15.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="260.479px" height="365.463px" viewBox="0 0 260.479 365.463" enable-background="new 0 0 260.479 365.463"
	 xml:space="preserve">
<g>
	<path d="M4.638,361.434c0,0,124.071-124.072,135.896-357.434c0,0,29.555,189.053,115.266,256.988
		C255.799,260.988,173.038,249.174,4.638,361.434z"/>
</g>
</svg>
    </a>
  
    
    
    
    
    <a href="https://datajoint.slack.com" target="_blank" rel="noopener" title="Slack" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1s21.16-47.06 47.06-47.06h47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06S448 171 448 196.9s-21.16 47.06-47.06 47.06h-47.06zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06S309 480 283.1 480s-47.06-21.16-47.06-47.06v-47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06s21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.linkedin.com/company/datajoint" target="_blank" rel="noopener" title="LinkedIn" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://twitter.com/datajoint" target="_blank" rel="noopener" title="Twitter" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
    <a href="https://github.com/datajoint" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="https://hub.docker.com/u/datajoint" target="_blank" rel="noopener" title="DockerHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://pypi.org/user/datajointbot" target="_blank" rel="noopener" title="PyPI" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3"/></svg>
    </a>
  
    
    
    
    
    <a href="https://stackoverflow.com/questions/tagged/datajoint" target="_blank" rel="noopener" title="StackOverflow" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M290.7 311 95 269.7 86.8 309l195.7 41zm51-87L188.2 95.7l-25.5 30.8 153.5 128.3zm-31.2 39.7L129.2 179l-16.7 36.5L293.7 300zM262 32l-32 24 119.3 160.3 32-24zm20.5 328h-200v39.7h200zm39.7 80H42.7V320h-40v160h359.5V320h-40z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.youtube.com/channel/UCdeCuFOTCXlVMRzh6Wk-lGg" target="_blank" rel="noopener" title="YouTube" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305m-317.51 213.508V175.185l142.739 81.205z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["toc.integrate", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
        <script src="https://js-na1.hs-scripts.com/23133402.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>